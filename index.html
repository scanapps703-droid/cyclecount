<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Cycle Count - Hybrid Storage</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- SheetJS Library untuk Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* CSS styles tetap sama seperti sebelumnya */
        :root {
            --primary: #ff2d20;
            --secondary: #47cdff;
            --dark: #1a1a1a;
            --light: #f8fafc;
            --gray: #e2e8f0;
            --text: #2c3e50;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }
        
        * {
            box-sizing: border-box;
            font-family: 'Nunito', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            margin: 0;
            padding: 0;
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Logo Styles */
        .logo {
            display: inline-block;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, #ea4335 100%);
            border-radius: 50%;
            position: relative;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }
        
        .logo::before {
            content: "CC";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: 800;
            font-size: 28px;
        }
        
        .logo.small {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            margin-bottom: 0;
        }
        
        .logo.small::before {
            font-size: 16px;
        }
        
        /* Login Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, #ea4335 100%);
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            padding: 30px;
            transition: transform 0.3s ease;
        }
        
        .login-card:hover {
            transform: translateY(-5px);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .login-logo h1 {
            color: var(--primary);
            font-weight: 800;
            font-size: 28px;
            margin: 0;
        }
        
        .login-logo p {
            color: #718096;
            margin-top: 5px;
        }
        
        /* Main App Styles */
        .app-container {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .navbar {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 0.8rem 1rem;
            position: sticky;
            top: 0;
            z-index: 1030;
        }
        
        .navbar-brand {
            color: var(--primary);
            font-weight: 800;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }
        
        .sidebar {
            background-color: var(--dark);
            color: white;
            width: 250px;
            min-height: calc(100vh - 56px);
            position: fixed;
            top: 56px;
            left: 0;
            padding-top: 20px;
            transition: transform 0.3s ease;
            z-index: 1020;
            overflow-y: auto;
            height: calc(100vh - 56px);
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar-menu li {
            margin-bottom: 5px;
        }
        
        .sidebar-menu a {
            color: #a0aec0;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 12px 20px;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: #2d3748;
            color: white;
            border-left: 3px solid var(--primary);
        }
        
        .sidebar-menu i {
            width: 25px;
            text-align: center;
            margin-right: 10px;
        }
        
        .sidebar-submenu {
            list-style: none;
            padding: 0;
            margin: 0;
            padding-left: 40px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .sidebar-submenu.expanded {
            max-height: 300px;
        }
        
        .sidebar-submenu li {
            margin-bottom: 2px;
        }
        
        .sidebar-submenu a {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .has-submenu > a::after {
            content: "\f107";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            margin-left: auto;
            transition: transform 0.3s;
        }
        
        .has-submenu.expanded > a::after {
            transform: rotate(180deg);
        }
        
        .main-content {
            margin-left: 250px;
            padding: 30px;
            transition: all 0.3s;
            min-height: calc(100vh - 56px);
            background-color: var(--light);
        }
        
        .section-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.04);
            padding: 25px;
            margin-bottom: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.07);
        }
        
        .section-title {
            color: var(--text);
            font-weight: 700;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray);
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
            color: var(--primary);
        }
        
        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #e53e3e;
            border-color: #e53e3e;
            color: white;
        }
        
        .btn-outline-primary {
            color: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary);
            color: white;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(255, 45, 32, 0.25);
        }
        
        /* Notification Styles */
        .notification {
            background-color: #fed7d7;
            color: #c53030;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid #f56565;
        }
        
        .count-saved {
            background-color: #c6f6d5;
            color: #2d7d32;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid #38a169;
        }
        
        /* Toast Notification */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
        }
        
        .toast {
            background-color: white;
            color: var(--text);
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 300px;
            border-left: 4px solid var(--success);
            animation: fadeIn 0.5s, fadeOut 0.5s 2.5s forwards;
        }
        
        .toast.error {
            border-left: 4px solid var(--danger);
        }
        
        .toast.info {
            border-left: 4px solid var(--secondary);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }
        
        /* Table Styles */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.04);
        }
        
        .table th {
            background-color: #f7fafc;
            font-weight: 600;
            color: #4a5568;
            white-space: nowrap;
            padding: 12px 15px;
        }
        
        .table td {
            padding: 12px 15px;
            vertical-align: middle;
        }
        
        /* Tabs */
        .nav-tabs {
            border-bottom: 2px solid var(--gray);
        }
        
        .nav-tabs .nav-link {
            color: #718096;
            font-weight: 600;
            border: none;
            padding: 12px 20px;
            transition: all 0.3s;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background: transparent;
        }
        
        /* Form Elements */
        .input-group-text {
            background-color: white;
        }
        
        .current-location-display {
            background-color: #e6f7ff;
            border-left: 4px solid var(--secondary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        /* GitHub Configuration */
        .github-config {
            background-color: #f6f8fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e1e4e8;
        }
        
        .sync-status {
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        
        .sync-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .sync-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .sync-status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Storage Status */
        .storage-status {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        
        .storage-status h5 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .storage-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            margin-bottom: 5px;
            overflow: hidden;
        }
        
        .storage-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        
        .storage-indexeddb {
            background-color: var(--primary);
        }
        
        .storage-localstorage {
            background-color: var(--secondary);
        }
        
        .storage-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        /* Responsive Design */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                width: 250px;
            }
            
            .sidebar.expanded {
                transform: translateX(0);
                box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-nav-backdrop {
                display: none;
                position: fixed;
                top: 56px;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 1010;
            }
            
            .mobile-nav-backdrop.expanded {
                display: block;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
            }
            
            .section-card {
                padding: 20px;
            }
            
            .github-action-buttons .btn {
                min-width: 100%;
                margin-bottom: 10px;
            }
        }
        
        /* Utilities */
        .text-primary {
            color: var(--primary) !important;
        }
        
        .bg-primary {
            background-color: var(--primary) !important;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Excel format info */
        .excel-format {
            background-color: #e8f4ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .excel-format h5 {
            color: #1a73e8;
            margin-bottom: 10px;
        }
        
        .excel-format ul {
            margin-bottom: 0;
            padding-left: 20px;
        }
        
        /* Sync buttons */
        .sync-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .sync-buttons .btn {
            flex: 1;
        }
        
        .sync-info {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 10px;
        }
        
        /* Progress bar */
        .progress {
            height: 8px;
            margin-bottom: 15px;
            border-radius: 4px;
            overflow: hidden;
            background-color: #e9ecef;
        }
        
        .progress-bar {
            background-color: var(--primary);
            transition: width 0.3s ease;
        }
        
        /* Master Data Tabs */
        .master-data-tabs {
            margin-bottom: 20px;
        }
        
        /* Sync animation */
        .sync-animation {
            display: inline-block;
        }
        
        @keyframes syncSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .syncing {
            animation: syncSpin 1.5s linear infinite;
        }

        /* GitHub Status Indicator */
        .github-status {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin-left: 10px;
        }
        
        .github-status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        
        .github-status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .github-status.checking {
            background-color: #fff3cd;
            color: #856404;
        }

        /* Upload Animation */
        .upload-progress {
            display: none;
            margin-top: 15px;
        }
        
        .upload-progress .progress-text {
            text-align: center;
            margin-top: 5px;
            font-size: 14px;
            color: #6c757d;
        }

        /* Pagination Styles */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 10px 0;
        }
        
        .pagination-info {
            font-size: 14px;
            color: #6c757d;
        }
        
        .pagination-controls {
            display: flex;
            gap: 5px;
        }
        
        .page-btn {
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            background-color: white;
            color: #007bff;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .page-btn.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .page-btn:hover:not(.active) {
            background-color: #e9ecef;
        }
        
        .page-btn:disabled {
            color: #6c757d;
            cursor: not-allowed;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="login-container" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <div class="logo"></div>
                <h1>CycleCount</h1>
                <p>Sistem Manajemen Stok</p>
            </div>
            <form id="login-form">
                <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" class="form-control" id="username" required placeholder="Masukkan username">
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" required placeholder="Masukkan password">
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="remember">
                    <label class="form-check-label" for="remember">Ingat saya</label>
                </div>
                <button type="submit" class="btn btn-primary w-100 py-2">
                    <i class="fas fa-sign-in-alt me-2"></i> Login
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app-container" class="app-container">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" id="sidebar-toggle">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <a class="navbar-brand" href="#">
                    <div class="logo small"></div>
                    CycleCount
                </a>
                <div class="d-flex align-items-center">
                    <span class="me-3 d-none d-md-block text-muted" id="user-welcome">Halo, User</span>
                    <span id="github-connection-status" class="github-status disconnected">
                        <i class="fas fa-plug me-1"></i> GitHub: Tidak Terhubung
                    </span>
                    <button class="btn btn-outline-danger btn-sm ms-2" id="logout-btn">
                        <i class="fas fa-sign-out-alt me-1"></i> Logout
                    </button>
                </div>
            </div>
        </nav>

        <!-- Sidebar and Backdrop -->
        <div class="mobile-nav-backdrop" id="mobile-nav-backdrop"></div>
        <div class="sidebar" id="sidebar">
            <ul class="sidebar-menu">
                <li>
                    <a href="#form" class="active" data-tab="form">
                        <i class="fas fa-clipboard-list"></i>
                        <span class="menu-text">Form Cycle Count</span>
                    </a>
                </li>
                <li>
                    <a href="#data-count" data-tab="data-count">
                        <i class="fas fa-history"></i>
                        <span class="menu-text">Data Count</span>
                    </a>
                </li>
                <li class="has-submenu" id="master-data-menu">
                    <a href="#master-data" data-tab="master-data">
                        <i class="fas fa-database"></i>
                        <span class="menu-text">Master Data</span>
                    </a>
                    <ul class="sidebar-submenu">
                        <li>
                            <a href="#master-location" data-tab="master-location">
                                <i class="fas fa-map-marker-alt"></i>
                                <span class="menu-text">Master Lokasi</span>
                            </a>
                        </li>
                        <li>
                            <a href="#master-ean" data-tab="master-ean">
                                <i class="fas fa-barcode"></i>
                                <span class="menu-text">Master EAN</span>
                            </a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="#inventory-balance" data-tab="inventory-balance">
                        <i class="fas fa-cubes"></i>
                        <span class="menu-text">Inventory Balance (IB)</span>
                    </a>
                </li>
                <li>
                    <a href="#github-config" data-tab="github-config">
                        <i class="fab fa-github"></i>
                        <span class="menu-text">Konfigurasi GitHub</span>
                    </a>
                </li>
                <li>
                    <a href="#storage-status" data-tab="storage-status">
                        <i class="fas fa-database"></i>
                        <span class="menu-text">Status Penyimpanan</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="main-content">
            <!-- Form Cycle Count Tab -->
            <div class="tab-content active" id="form-tab">
                <div class="section-card">
                    <h2 class="section-title">
                        <i class="fas fa-clipboard-list"></i> Form Cycle Count
                    </h2>
                    
                    <div class="notification" id="notification">
                        <i class="fas fa-exclamation-circle"></i> Data tidak ditemukan di inventory balanced. Pastikan lokasi dan EAN sudah terdaftar.
                    </div>
                    
                    <div class="count-saved" id="count-saved">
                        <i class="fas fa-info-circle"></i> Count untuk tipe ini sudah disimpan sebelumnya dan hanya dapat dilihat.
                    </div>
                    
                    <form id="cycleCountForm">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="location" class="form-label">Validation Code</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="location" name="location" required placeholder="Masukkan kode validasi lokasi">
                                        <button type="button" class="btn btn-primary" id="save-location-btn">
                                            <i class="fas fa-save"></i> Simpan
                                        </button>
                                    </div>
                                    <div class="form-text">Masukkan Validation Code, akan otomatis berubah menjadi Location Code</div>
                                </div>
                                
                                <!-- Current Location Display -->
                                <div class="current-location-display" id="current-location-display" style="display: none;">
                                    <h5>Lokasi Saat Ini: <span id="current-location-name" class="fw-bold text-primary"></span></h5>
                                    <p class="mb-0">Jumlah SKU: <span id="current-location-sku-count" class="fw-bold">0</span></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3 ean-input-container">
                                    <label for="ean" class="form-label">EAN</label>
                                    <input type="text" class="form-control" id="ean" name="ean" required placeholder="Scan atau masukkan kode EAN" autocomplete="off">
                                    <div class="ean-loading" id="ean-loading" style="position: absolute; right: 10px; top: 70%; transform: translateY(-50%); display: none;">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="sku" class="form-label">SKU</label>
                                    <input type="text" class="form-control" id="sku" name="sku" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="description" name="description" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="traceId" class="form-label">Trace ID</label>
                                    <input type="text" class="form-control" id="traceId" name="traceId" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="countType" class="form-label">Count Type</label>
                                    <div class="row g-2">
                                        <div class="col-5">
                                            <select class="form-select" id="countType" name="countType">
                                                <option value="1stCount">1st Count</option>
                                                <option value="2ndCount">2nd Count</option>
                                                <option value="3rdCount">3rd Count</option>
                                            </select>
                                        </div>
                                        <div class="col-7">
                                            <input type="number" class="form-control" id="qty" name="qty" min="0" placeholder="Qty">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="remark" class="form-label">Remark</label>
                            <textarea class="form-control" id="remark" name="remark" rows="3" placeholder="Keterangan tambahan (wajib diisi jika data tidak ada di inventory)"></textarea>
                        </div>

                        <!-- Auto-sync Toggle -->
                        <div class="auto-sync-toggle mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="auto-sync-toggle" checked>
                                <label class="form-check-label" for="auto-sync-toggle">
                                    Auto-sync ke GitHub setelah menyimpan
                                </label>
                            </div>
                        </div>
                        
                        <div class="navigation-container card mb-4" id="navigation-container" style="display: none;">
                            <div class="card-body d-flex justify-content-center align-items-center">
                                <button type="button" class="btn btn-outline-primary me-3" id="prev-btn" disabled>
                                    <i class="fas fa-chevron-left"></i> Previous
                                </button>
                                <div class="nav-info mx-3 fw-bold" id="nav-info">Item 1 of 1</div>
                                <button type="button" class="btn btn-outline-primary ms-3" id="next-btn" disabled>
                                    Next <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100 py-2">
                            <i class="fas fa-save me-2"></i> Simpan Data Count
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Data Count Tab -->
            <div class="tab-content" id="data-count-tab" style="display: none;">
                <div class="section-card">
                    <h2 class="section-title">
                        <i class="fas fa-history"></i> Data Count History
                    </h2>
                    
                    <!-- GitHub Sync Buttons for Data Count -->
                    <div class="sync-buttons">
                        <button type="button" class="btn btn-primary" id="sync-cyclecount">
                            <i class="fas fa-sync-alt"></i> Sync Data Cycle Count ke GitHub
                        </button>
                        <button type="button" class="btn btn-info" id="sync-from-github-cyclecount">
                            <i class="fas fa-download"></i> Sync dari GitHub
                        </button>
                        <button type="button" class="btn btn-success" id="sync-all-data">
                            <i class="fas fa-cloud-upload-alt"></i> Sync Semua Data
                        </button>
                    </div>
                    <div class="progress" id="sync-cyclecount-progress" style="display: none;">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="sync-info">
                        <i class="fas fa-info-circle"></i> Terakhir sinkronisasi: <span id="last-sync-cyclecount">Belum pernah</span>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="d-flex flex-wrap align-items-center gap-2">
                                <label for="start-date" class="form-label mb-0">Dari:</label>
                                <input type="date" class="form-control me-3" id="start-date" style="width: auto;">
                                
                                <label for="end-date" class="form-label mb-0">Sampai:</label>
                                <input type="date" class="form-control me-3" id="end-date" style="width: auto;">
                                
                                <button class="btn btn-outline-primary" id="filter-btn">
                                    <i class="fas fa-filter"></i> Filter
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4 d-flex justify-content-end gap-2">
                            <button id="export-btn" class="btn btn-success">
                                <i class="fas fa-file-excel"></i> Export
                            </button>
                            <button id="delete-selected-btn" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover" id="data-count-table">
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 50px;">
                                        <input type="checkbox" class="form-check-input" id="select-all">
                                    </th>
                                    <th scope="col">Tanggal</th>
                                    <th scope="col">Lokasi</th>
                                    <th scope="col">EAN</th>
                                    <th scope="col">SKU</th>
                                    <th scope="col">Count Type</th>
                                    <th scope="col">Qty</th>
                                    <th scope="col" style="width: 100px;">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="pagination-container" id="data-count-pagination">
                        <div class="pagination-info" id="data-count-pagination-info"></div>
                        <div class="pagination-controls" id="data-count-pagination-controls"></div>
                    </div>
                </div>
            </div>
            
            <!-- Master Lokasi Tab -->
            <div class="tab-content" id="master-location-tab" style="display: none;">
                <div class="section-card">
                    <h2 class="section-title">
                        <i class="fas fa-map-marker-alt"></i> Master Data Lokasi
                    </h2>
                    
                    <!-- GitHub Sync Buttons for Master Data Lokasi -->
                    <div class="sync-buttons">
                        <button type="button" class="btn btn-primary" id="sync-master-location">
                            <i class="fas fa-sync-alt"></i> Sync Data Master Lokasi ke GitHub
                        </button>
                        <button type="button" class="btn btn-info" id="sync-from-github-master-location">
                            <i class="fas fa-download"></i> Sync dari GitHub
                        </button>
                    </div>
                    <div class="progress" id="sync-master-location-progress" style="display: none;">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="sync-info">
                        <i class="fas fa-info-circle"></i> Terakhir sinkronisasi: <span id="last-sync-master-location">Belum pernah</span>
                    </div>
                    
                    <div class="d-flex flex-wrap gap-2 mb-4">
                        <button id="upload-master-location-btn" class="btn btn-success">
                            <i class="fas fa-upload"></i> Upload Excel
                        </button>
                        <button id="download-master-location-btn" class="btn btn-primary">
                            <i class="fas fa-download"></i> Download Excel
                        </button>
                        <button id="clear-master-location-btn" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Hapus Semua
                        </button>
                        <button id="add-master-location-btn" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Tambah Data
                        </button>
                    </div>

                    <!-- Upload Progress -->
                    <div class="upload-progress" id="upload-master-location-progress">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">Memproses data: <span id="upload-master-location-text">0%</span></div>
                    </div>

                    <!-- Excel Format Info -->
                    <div class="excel-format">
                        <h5><i class="fas fa-info-circle"></i> Format File Excel</h5>
                        <p>File Excel harus memiliki kolom dengan header berikut:</p>
                        <ul>
                            <li><strong>Validation Code</strong> (wajib)</li>
                            <li><strong>Location</strong> (wajib)</li>
                        </ul>
                    </div>
                    
                    <input type="file" id="master-location-file-input" accept=".xlsx, .xls" style="display: none;">
                    
                    <div class="table-responsive">
                        <table class="table table-hover" id="master-location-table">
                            <thead>
                                <tr>
                                    <th scope="col">Validation Code</th>
                                    <th scope="col">Location</th>
                                    <th scope="col" style="width: 100px;">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="pagination-container" id="master-location-pagination">
                        <div class="pagination-info" id="master-location-pagination-info"></div>
                        <div class="pagination-controls" id="master-location-pagination-controls"></div>
                    </div>
                </div>
            </div>
            
            <!-- Master EAN Tab -->
            <div class="tab-content" id="master-ean-tab" style="display: none;">
                <div class="section-card">
                    <h2 class="section-title">
                        <i class="fas fa-barcode"></i> Master Data EAN
                    </h2>
                    
                    <!-- GitHub Sync Buttons for Master Data EAN -->
                    <div class="sync-buttons">
                        <button type="button" class="btn btn-primary" id="sync-master-ean">
                            <i class="fas fa-sync-alt"></i> Sync Data Master EAN ke GitHub
                        </button>
                        <button type="button" class="btn btn-info" id="sync-from-github-master-ean">
                            <i class="fas fa-download"></i> Sync dari GitHub
                        </button>
                    </div>
                    <div class="progress" id="sync-master-ean-progress" style="display: none;">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="sync-info">
                        <i class="fas fa-info-circle"></i> Terakhir sinkronisasi: <span id="last-sync-master-ean">Belum pernah</span>
                    </div>
                    
                    <div class="d-flex flex-wrap gap-2 mb-4">
                        <button id="upload-master-ean-btn" class="btn btn-success">
                            <i class="fas fa-upload"></i> Upload Excel
                        </button>
                        <button id="download-master-ean-btn" class="btn btn-primary">
                            <i class="fas fa-download"></i> Download Excel
                        </button>
                        <button id="clear-master-ean-btn" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Hapus Semua
                        </button>
                        <button id="add-master-ean-btn" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Tambah Data
                        </button>
                    </div>

                    <!-- Upload Progress -->
                    <div class="upload-progress" id="upload-master-ean-progress">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">Memproses data: <span id="upload-master-ean-text">0%</span></div>
                    </div>

                    <!-- Excel Format Info -->
                    <div class="excel-format">
                        <h5><i class="fas fa-info-circle"></i> Format File Excel</h5>
                        <p>File Excel harus memiliki kolom dengan header berikut:</p>
                        <ul>
                            <li><strong>EAN</strong> (wajib)</li>
                            <li><strong>SKU</strong> (wajib)</li>
                        </ul>
                    </div>
                    
                    <input type="file" id="master-ean-file-input" accept=".xlsx, .xls" style="display: none;">
                    
                    <div class="table-responsive">
                        <table class="table table-hover" id="master-ean-table">
                            <thead>
                                <tr>
                                    <th scope="col">EAN</th>
                                    <th scope="col">SKU</th>
                                    <th scope="col" style="width: 100px;">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="pagination-container" id="master-ean-pagination">
                        <div class="pagination-info" id="master-ean-pagination-info"></div>
                        <div class="pagination-controls" id="master-ean-pagination-controls"></div>
                    </div>
                </div>
            </div>
            
            <!-- Inventory Balance Tab -->
            <div class="tab-content" id="inventory-balance-tab" style="display: none;">
                <div class="section-card">
                    <h2 class="section-title">
                        <i class="fas fa-cubes"></i> Inventory Balance (IB) Management
                    </h2>
                    
                    <!-- GitHub Sync Buttons for Inventory Data -->
                    <div class="sync-buttons">
                        <button type="button" class="btn btn-primary" id="sync-inventory">
                            <i class="fas fa-sync-alt"></i> Sync Data Inventory ke GitHub
                        </button>
                        <button type="button" class="btn btn-info" id="sync-from-github-inventory">
                            <i class="fas fa-download"></i> Sync dari GitHub
                        </button>
                    </div>
                    <div class="progress" id="sync-inventory-progress" style="display: none;">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="sync-info">
                        <i class="fas fa-info-circle"></i> Terakhir sinkronisasi: <span id="last-sync-inventory">Belum pernah</span>
                    </div>
                    
                    <div class="d-flex flex-wrap gap-2 mb-4">
                        <button id="upload-inventory-btn" class="btn btn-success">
                            <i class="fas fa-upload"></i> Upload Excel
                        </button>
                        <button id="download-inventory-btn" class="btn btn-primary">
                            <i class="fas fa-download"></i> Download Excel
                        </button>
                        <button id="clear-inventory-btn" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Hapus Semua
                        </button>
                        <button id="add-inventory-btn" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Tambah Data
                        </button>
                    </div>

                    <!-- Upload Progress -->
                    <div class="upload-progress" id="upload-inventory-progress">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">Memproses data: <span id="upload-inventory-text">0%</span></div>
                    </div>

                    <!-- Excel Format Info -->
                    <div class="excel-format">
                        <h5><i class="fas fa-info-circle"></i> Format File Excel</h5>
                        <p>File Excel harus memiliki kolom dengan header berikut:</p>
                        <ul>
                            <li><strong>Location ID</strong> (wajib)</li>
                            <li><strong>SKU</strong> (wajib)</li>
                            <li><strong>SKU Descr(L)</strong></li>
                            <li><strong>Trace ID</strong></li>
                            <li><strong>QTY On Hand</strong></li>
                        </ul>
                    </div>
                    
                    <input type="file" id="inventory-file-input" accept=".xlsx, .xls" style="display: none;">
                    
                    <div class="table-responsive">
                        <table class="table table-hover" id="inventory-table">
                            <thead>
                                <tr>
                                    <th scope="col">Location ID</th>
                                    <th scope="col">SKU</th>
                                    <th scope="col">SKU Descr(L)</th>
                                    <th scope="col">Trace ID</th>
                                    <th scope="col">QTY On Hand</th>
                                    <th scope="col" style="width: 100px;">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="pagination-container" id="inventory-pagination">
                        <div class="pagination-info" id="inventory-pagination-info"></div>
                        <div class="pagination-controls" id="inventory-pagination-controls"></div>
                    </div>
                </div>
            </div>
            
            <!-- GitHub Configuration Tab -->
            <div class="tab-content" id="github-config-tab" style="display: none;">
                <div class="section-card">
                    <h2 class="section-title">
                        <i class="fab fa-github"></i> Konfigurasi GitHub
                    </h2>
                    
                    <div class="github-config">
                        <h4><i class="fab fa-github"></i> Konfigurasi Penyimpanan GitHub</h4>
                        
                        <div class="mb-3">
                            <label for="github-token" class="form-label">GitHub Personal Access Token</label>
                            <input type="password" class="form-control" id="github-token" placeholder="Masukkan token akses GitHub">
                            <div class="form-text">
                                Token diperlukan untuk mengakses repository GitHub. 
                                <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token" target="_blank">Cara membuat token</a>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="github-owner" class="form-label">Pemilik Repository (Owner)</label>
                                <input type="text" class="form-control" id="github-owner" placeholder="Nama pengguna atau organisasi">
                            </div>
                            <div class="col-md-6">
                                <label for="github-repo" class="form-label">Nama Repository</label>
                                <input type="text" class="form-control" id="github-repo" placeholder="Nama repository">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="github-branch" class="form-label">Cabang (Branch)</label>
                            <input type="text" class="form-control" id="github-branch" value="main" placeholder="Nama cabang (default: main)">
                        </div>
                        
                        <div class="mb-3">
                            <label for="sync-interval" class="form-label">Interval Sinkronisasi Otomatis (menit)</label>
                            <input type="number" class="form-control" id="sync-interval" min="1" value="5" placeholder="Interval dalam menit">
                            <div class="form-text">
                                Setiap interval, data akan dikirim ke GitHub lalu ditarik dari GitHub
                            </div>
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="auto-sync-enabled">
                            <label class="form-check-label" for="auto-sync-enabled">
                                Aktifkan Sinkronisasi Otomatis
                            </label>
                        </div>
                        
                        <button type="button" class="btn btn-primary" id="save-github-config">
                            <i class="fas fa-save"></i> Simpan Konfigurasi
                        </button>
                        <button type="button" class="btn btn-info ms-2" id="test-github-connection">
                            <i class="fas fa-plug"></i> Test Koneksi
                        </button>
                        <button type="button" class="btn btn-success ms-2" id="sync-all-to-github">
                            <i class="fas fa-cloud-upload-alt"></i> Sync Semua Data ke GitHub
                        </button>
                        <button type="button" class="btn btn-warning ms-2" id="sync-all-from-github">
                            <i class="fas fa-cloud-download-alt"></i> Sync Semua Data dari GitHub
                        </button>

                        <div class="mt-3" id="github-connection-test-result"></div>
                    </div>
                    
                    <div class="github-config">
                        <h4><i class="fas fa-info-circle"></i> Informasi</h4>
                        <p>Fitur ini memungkinkan Anda menyimpan data Cycle Count, Master Data, dan Inventory Balance ke repository GitHub.</p>
                        <ul>
                            <li>Data Cycle Count akan disimpan dalam file <code>cycle_count.json</code></li>
                            <li>Data Master Lokasi akan disimpan dalam file <code>master_location.json</code></li>
                            <li>Data Master EAN akan disimpan dalam file <code>master_ean.json</code></li>
                            <li>Data Inventory akan disimpan dalam file <code>InventoryBalance.json</code></li>
                            <li>Pastikan repository sudah dibuat sebelumnya di akun GitHub Anda</li>
                            <li>Token akses harus memiliki izin untuk membaca dan menulis ke repository</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Storage Status Tab -->
            <div class="tab-content" id="storage-status-tab" style="display: none;">
                <div class="section-card">
                    <h2 class="section-title">
                        <i class="fas fa-database"></i> Status Penyimpanan Hybrid
                    </h2>
                    
                    <div class="storage-status">
                        <h5><i class="fas fa-info-circle"></i> Status Penyimpanan Data</h5>
                        <p>Sistem menggunakan penyimpanan hybrid yang mengoptimalkan performa dan kapasitas:</p>
                        
                        <div class="mb-3">
                            <div class="storage-bar">
                                <div class="storage-fill storage-indexeddb" id="indexeddb-usage" style="width: 0%"></div>
                            </div>
                            <div class="storage-info">
                                <span>IndexedDB (Penyimpanan Utama)</span>
                                <span id="indexeddb-stats">0 items</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="storage-bar">
                                <div class="storage-fill storage-localstorage" id="localstorage-usage" style="width: 0%"></div>
                            </div>
                            <div class="storage-info">
                                <span>LocalStorage (Fallback)</span>
                                <span id="localstorage-stats">0 items</span>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button class="btn btn-primary me-2" id="refresh-storage-stats">
                                <i class="fas fa-sync-alt"></i> Refresh Status
                            </button>
                            <button class="btn btn-outline-danger" id="clear-all-data">
                                <i class="fas fa-trash"></i> Hapus Semua Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="github-config mt-4">
                        <h5><i class="fas fa-cogs"></i> Pengaturan Penyimpanan</h5>
                        
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="enable-indexeddb" checked>
                            <label class="form-check-label" for="enable-indexeddb">
                                Aktifkan IndexedDB (Rekomendasi)
                            </label>
                        </div>
                        
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="enable-localstorage" checked>
                            <label class="form-check-label" for="enable-localstorage">
                                Aktifkan LocalStorage (Fallback)
                            </label>
                        </div>
                        
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="enable-github-sync" checked>
                            <label class="form-check-label" for="enable-github-sync">
                                Aktifkan Sinkronisasi GitHub (Backup)
                            </label>
                        </div>
                        
                        <button class="btn btn-outline-primary mt-2" id="save-storage-settings">
                            <i class="fas fa-save"></i> Simpan Pengaturan
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div class="toast-container" id="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==============================
        // GITHUB SYNC MANAGER - FIXED
        // ==============================
        
        class GitHubSyncManager {
            constructor(storageManager, userKey) {
                this.storageManager = storageManager;
                this.userKey = userKey;
                this.config = JSON.parse(localStorage.getItem(`githubConfig_${userKey}`)) || {};
                this.isConnected = false;
            }

            async getFileSha(owner, repo, path, branch = 'main') {
                try {
                    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `token ${this.config.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.status === 200) {
                        const fileData = await response.json();
                        return fileData.sha;
                    } else if (response.status === 404) {
                        return null; // File doesn't exist yet
                    } else {
                        throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('Error getting file SHA:', error);
                    throw error;
                }
            }

            async uploadToGitHub(path, data, retryCount = 2) {
                if (!this.config.token || !this.config.owner || !this.config.repo) {
                    throw new Error('GitHub configuration incomplete');
                }

                try {
                    const content = JSON.stringify(data, null, 2);
                    const contentBase64 = btoa(unescape(encodeURIComponent(content)));
                    const branch = this.config.branch || 'main';

                    // Get SHA if file exists
                    let sha = null;
                    try {
                        sha = await this.getFileSha(this.config.owner, this.config.repo, path, branch);
                    } catch (error) {
                        console.warn('Error getting file SHA, uploading as new file:', error);
                        // Continue without SHA - will create new file
                    }

                    const url = `https://api.github.com/repos/${this.config.owner}/${this.config.repo}/contents/${path}`;
                    const body = {
                        message: `Update ${path} via CycleCount App - ${new Date().toLocaleString('id-ID')}`,
                        content: contentBase64,
                        branch: branch
                    };

                    if (sha) {
                        body.sha = sha;
                    }

                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${this.config.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    });

                    if (!response.ok) {
                        // If we get a 409 and have retries left, try again with fresh SHA
                        if (response.status === 409 && retryCount > 0) {
                            console.log(`Retrying upload for ${path} due to 409 conflict... (${retryCount} retries left)`);
                            // Wait a bit before retrying
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            return this.uploadToGitHub(path, data, retryCount - 1);
                        }
                        
                        const errorData = await response.json();
                        throw new Error(`GitHub API error: ${response.status} - ${errorData.message || response.statusText}`);
                    }

                    const result = await response.json();
                    console.log(`Successfully uploaded ${path} to GitHub`, result);
                    return result;
                } catch (error) {
                    console.error('Error uploading to GitHub:', error);
                    throw error;
                }
            }

            async downloadFromGitHub(path) {
                if (!this.config.token || !this.config.owner || !this.config.repo) {
                    throw new Error('GitHub configuration incomplete');
                }

                try {
                    const branch = this.config.branch || 'main';
                    const url = `https://api.github.com/repos/${this.config.owner}/${this.config.repo}/contents/${path}?ref=${branch}`;
                    
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `token ${this.config.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.status === 404) {
                        return null; // File doesn't exist
                    }

                    if (!response.ok) {
                        throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                    }

                    const fileData = await response.json();
                    
                    // Handle case where content might be empty
                    if (!fileData.content) {
                        return null;
                    }
                    
                    const content = decodeURIComponent(escape(atob(fileData.content)));
                    return JSON.parse(content);
                } catch (error) {
                    console.error('Error downloading from GitHub:', error);
                    
                    // Return empty array instead of throwing for non-existent files
                    if (error.message.includes('404')) {
                        return null;
                    }
                    
                    throw error;
                }
            }

            async syncDataWithGithub(dataType, data) {
                try {
                    const filename = this.getFilenameForDataType(dataType);
                    await this.uploadToGitHub(filename, data);
                    return true;
                } catch (error) {
                    console.error(`Error syncing ${dataType} with GitHub:`, error);
                    throw error;
                }
            }

            async syncAllDataToGitHub() {
                try {
                    showToast('Memulai sinkronisasi ke GitHub...', 'info');
                    
                    const allData = await this.storageManager.exportAllData();
                    
                    // Sync each data type sequentially to avoid rate limiting
                    await this.syncDataWithGithub('cycle_count', allData.cycleCount);
                    await this.syncDataWithGithub('master_location', allData.masterLocation);
                    await this.syncDataWithGithub('master_ean', allData.masterEan);
                    await this.syncDataWithGithub('InventoryBalance', allData.inventory);
                    
                    // Update last sync timestamps
                    this.updateLastSyncTimestamps();
                    
                    showToast('Sinkronisasi ke GitHub berhasil!');
                    return true;
                } catch (error) {
                    console.error('Error during GitHub sync:', error);
                    showToast(`Error sinkronisasi GitHub: ${error.message}`, 'error');
                    throw error;
                }
            }

            async syncFromGitHub() {
                try {
                    showToast('Memuat data dari GitHub...', 'info');
                    
                    // Download data dari GitHub - handle cases where files don't exist
                    const cycleCountData = await this.downloadFromGitHub('cycle_count.json') || [];
                    const masterLocationData = await this.downloadFromGitHub('master_location.json') || [];
                    const masterEanData = await this.downloadFromGitHub('master_ean.json') || [];
                    const inventoryData = await this.downloadFromGitHub('InventoryBalance.json') || [];
                    
                    // Import data to storage
                    if (cycleCountData.length > 0) {
                        for (const item of cycleCountData) {
                            await this.storageManager.saveCycleCount(item);
                        }
                    }
                    
                    if (masterLocationData.length > 0) {
                        await this.storageManager.saveMasterLocation(masterLocationData);
                    }
                    
                    if (masterEanData.length > 0) {
                        await this.storageManager.saveMasterEan(masterEanData);
                    }
                    
                    if (inventoryData.length > 0) {
                        await this.storageManager.saveInventory(inventoryData);
                    }
                    
                    showToast('Data dari GitHub berhasil dimuat!');
                    return true;
                } catch (error) {
                    console.error('Error syncing from GitHub:', error);
                    showToast(`Error memuat data dari GitHub: ${error.message}`, 'error');
                    throw error;
                }
            }

            getFilenameForDataType(dataType) {
                const filenames = {
                    'cycle_count': 'cycle_count.json',
                    'master_location': 'master_location.json',
                    'master_ean': 'master_ean.json',
                    'InventoryBalance': 'InventoryBalance.json'
                };
                
                return filenames[dataType] || `${dataType}.json`;
            }

            updateLastSyncTimestamps() {
                const now = new Date().toLocaleString('id-ID');
                
                // Update UI elements
                const elements = {
                    'last-sync-cyclecount': now,
                    'last-sync-master-location': now,
                    'last-sync-master-ean': now,
                    'last-sync-inventory': now
                };
                
                Object.keys(elements).forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = now;
                    }
                });
                
                // Save to localStorage
                localStorage.setItem(`lastSync_${this.userKey}`, now);
            }

            loadLastSyncTimestamps() {
                const lastSync = localStorage.getItem(`lastSync_${this.userKey}`) || 'Belum pernah';
                
                const elements = [
                    'last-sync-cyclecount',
                    'last-sync-master-location',
                    'last-sync-master-ean',
                    'last-sync-inventory'
                ];
                
                elements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = lastSync;
                    }
                });
            }

            // Test connection to GitHub
            async testConnection() {
                if (!this.config.token || !this.config.owner || !this.config.repo) {
                    this.isConnected = false;
                    return false;
                }

                try {
                    const url = `https://api.github.com/repos/${this.config.owner}/${this.config.repo}`;
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `token ${this.config.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.ok) {
                        this.isConnected = true;
                        return true;
                    } else {
                        this.isConnected = false;
                        return false;
                    }
                } catch (error) {
                    console.error('Error testing GitHub connection:', error);
                    this.isConnected = false;
                    return false;
                }
            }

            // Reset connection status
            resetConnection() {
                this.isConnected = false;
                this.config = {};
            }
        }

        // ==============================
        // HYBRID STORAGE MANAGER
        // ==============================
        
        class HybridStorageManager {
            constructor(userKey) {
                this.userKey = userKey;
                this.dbName = `CycleCountDB_${userKey}`;
                this.dbVersion = 2;
                this.db = null;
                this.settings = {
                    enableIndexedDB: true,
                    enableLocalStorage: true,
                    enableGitHubSync: true
                };
                this.initPromise = this.initDB();
                this.loadSettings();
            }
            
            loadSettings() {
                const savedSettings = localStorage.getItem(`storageSettings_${this.userKey}`);
                if (savedSettings) {
                    this.settings = { ...this.settings, ...JSON.parse(savedSettings) };
                }
            }
            
            saveSettings() {
                localStorage.setItem(`storageSettings_${this.userKey}`, JSON.stringify(this.settings));
            }
            
            async initDB() {
                if (!this.settings.enableIndexedDB) {
                    console.log('IndexedDB disabled by settings');
                    return Promise.resolve(null);
                }
                
                return new Promise((resolve, reject) => {
                    if (!window.indexedDB) {
                        reject(new Error("Browser doesn't support IndexedDB"));
                        return;
                    }
                    
                    const request = indexedDB.open(this.dbName, this.dbVersion);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve(this.db);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        if (!db.objectStoreNames.contains('cycleCount')) {
                            const cycleCountStore = db.createObjectStore('cycleCount', { keyPath: 'id', autoIncrement: true });
                            cycleCountStore.createIndex('timestamp', 'timestamp', { unique: false });
                            cycleCountStore.createIndex('location', 'location', { unique: false });
                            cycleCountStore.createIndex('ean', 'ean', { unique: false });
                        }
                        
                        if (!db.objectStoreNames.contains('masterLocation')) {
                            const masterLocationStore = db.createObjectStore('masterLocation', { keyPath: 'validationCode' });
                            masterLocationStore.createIndex('location', 'location', { unique: false });
                        }
                        
                        if (!db.objectStoreNames.contains('masterEan')) {
                            const masterEanStore = db.createObjectStore('masterEan', { keyPath: 'ean' });
                            masterEanStore.createIndex('sku', 'sku', { unique: false });
                        }
                        
                        if (!db.objectStoreNames.contains('inventory')) {
                            const inventoryStore = db.createObjectStore('inventory', { keyPath: 'id', autoIncrement: true });
                            inventoryStore.createIndex('locationId', 'locationId', { unique: false });
                            inventoryStore.createIndex('sku', 'sku', { unique: false });
                            inventoryStore.createIndex('location_sku', ['locationId', 'sku'], { unique: true });
                        }
                    };
                    
                    request.onblocked = () => {
                        console.warn('Database upgrade blocked');
                    };
                });
            }
            
            // ==============================
            // CYCLE COUNT DATA METHODS
            // ==============================
            
            async saveCycleCount(data) {
                if (!data.id) {
                    data.id = Date.now() + Math.random().toString(36).substr(2, 9);
                }
                
                data.timestamp = data.timestamp || new Date().toISOString();
                
                if (this.settings.enableIndexedDB && this.db) {
                    try {
                        const tx = this.db.transaction(['cycleCount'], 'readwrite');
                        const store = tx.objectStore('cycleCount');
                        await store.put(data);
                    } catch (error) {
                        console.error('Error saving to IndexedDB:', error);
                    }
                }
                
                if (this.settings.enableLocalStorage) {
                    try {
                        let localStorageData = JSON.parse(localStorage.getItem(`cycleCountData_${this.userKey}`)) || [];
                        const existingIndex = localStorageData.findIndex(item => item.id === data.id);
                        if (existingIndex !== -1) {
                            localStorageData[existingIndex] = data;
                        } else {
                            localStorageData.push(data);
                        }
                        localStorage.setItem(`cycleCountData_${this.userKey}`, JSON.stringify(localStorageData));
                    } catch (error) {
                        console.error('Error saving to localStorage:', error);
                    }
                }
                
                return data;
            }
            
            async getCycleCount(startDate = null, endDate = null) {
                if (this.settings.enableIndexedDB && this.db) {
                    try {
                        const tx = this.db.transaction(['cycleCount'], 'readonly');
                        const store = tx.objectStore('cycleCount');
                        const index = store.index('timestamp');
                        
                        let range = null;
                        if (startDate && endDate) {
                            range = IDBKeyRange.bound(
                                startDate.toISOString(),
                                endDate.toISOString()
                            );
                        }
                        
                        const data = await new Promise((resolve, reject) => {
                            const request = range ? index.getAll(range) : store.getAll();
                            request.onsuccess = () => resolve(request.result);
                            request.onerror = () => reject(request.error);
                        });
                        
                        data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        return data;
                    } catch (error) {
                        console.warn('IndexedDB error, fallback ke localStorage:', error);
                    }
                }
                
                if (this.settings.enableLocalStorage) {
                    try {
                        let data = JSON.parse(localStorage.getItem(`cycleCountData_${this.userKey}`)) || [];
                        
                        if (startDate && endDate) {
                            data = data.filter(item => {
                                const itemDate = new Date(item.timestamp);
                                return itemDate >= startDate && itemDate <= endDate;
                            });
                        }
                        
                        data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        return data;
                    } catch (error) {
                        console.error('Error reading from localStorage:', error);
                    }
                }
                
                return [];
            }
            
            async deleteCycleCount(id) {
                if (this.settings.enableIndexedDB && this.db) {
                    try {
                        const tx = this.db.transaction(['cycleCount'], 'readwrite');
                        const store = tx.objectStore('cycleCount');
                        await store.delete(id);
                    } catch (error) {
                        console.error('Error deleting from IndexedDB:', error);
                    }
                }
                
                if (this.settings.enableLocalStorage) {
                    try {
                        let localStorageData = JSON.parse(localStorage.getItem(`cycleCountData_${this.userKey}`)) || [];
                        localStorageData = localStorageData.filter(item => item.id !== id);
                        localStorage.setItem(`cycleCountData_${this.userKey}`, JSON.stringify(localStorageData));
                    } catch (error) {
                        console.error('Error deleting from localStorage:', error);
                    }
                }
            }
            
            async deleteMultipleCycleCount(ids) {
                if (this.settings.enableIndexedDB && this.db) {
                    try {
                        const tx = this.db.transaction(['cycleCount'], 'readwrite');
                        const store = tx.objectStore('cycleCount');
                        
                        for (const id of ids) {
                            await store.delete(id);
                        }
                    } catch (error) {
                        console.error('Error deleting multiple from IndexedDB:', error);
                    }
                }
                
                if (this.settings.enableLocalStorage) {
                    try {
                        let localStorageData = JSON.parse(localStorage.getItem(`cycleCountData_${this.userKey}`)) || [];
                        localStorageData = localStorageData.filter(item => !ids.includes(item.id));
                        localStorage.setItem(`cycleCountData_${this.userKey}`, JSON.stringify(localStorageData));
                    } catch (error) {
                        console.error('Error deleting multiple from localStorage:', error);
                    }
                }
            }
            
            // ==============================
            // MASTER DATA METHODS
            // ==============================
            
            async saveMasterLocation(data) {
                const dataArray = Array.isArray(data) ? data : [data];
                
                if (this.settings.enableIndexedDB && this.db) {
                    try {
                        const tx = this.db.transaction(['masterLocation'], 'readwrite');
                        const store = tx.objectStore('masterLocation');
                        
                        for (const item of dataArray) {
                            await store.put(item);
                        }
                    } catch (error) {
                        console.error('Error saving master location to IndexedDB:', error);
                    }
                }
                
                if (this.settings.enableLocalStorage) {
                    try {
                        if (Array.isArray(data)) {
                            localStorage.setItem(`masterLocationData_${this.userKey}`, JSON.stringify(data));
                        } else {
                            let localStorageData = JSON.parse(localStorage.getItem(`masterLocationData_${this.userKey}`)) || [];
                            const existingIndex = localStorageData.findIndex(item => item.validationCode === data.validationCode);
                            
                            if (existingIndex !== -1) {
                                localStorageData[existingIndex] = data;
                            } else {
                                localStorageData.push(data);
                            }
                            
                            localStorage.setItem(`masterLocationData_${this.userKey}`, JSON.stringify(localStorageData));
                        }
                    } catch (error) {
                        console.error('Error saving master location to localStorage:', error);
                    }
                }
                
                return dataArray;
            }
            
            async getMasterLocation() {
                if (this.settings.enableIndexedDB && this.db) {
                    try {
                        const tx = this.db.transaction(['masterLocation'], 'readonly');
                        const store = tx.objectStore('masterLocation');
                        
                        const data = await new Promise((resolve, reject) => {
                            const request = store.getAll();
                            request.onsuccess = () => resolve(request.result);
                            request.onerror = () => reject(request.error);
                        });
                        
                        return data;
                    } catch (error) {
                        console.warn('IndexedDB error for master location, fallback ke localStorage:', error);
                    }
                }
                
                if (this.settings.enableLocalStorage) {
                    try {
                        return JSON.parse(localStorage.getItem(`masterLocationData_${this.userKey}`)) || [];
                    } catch (error) {
                        console.error('Error reading master location from localStorage:', error);
                        return [];
                    }
                }
                
                return [];
            }
            
            async deleteMasterLocation(validationCode) {
                if (this.settings.enableIndexedDB && this.db) {
                    try {
                        const tx = this.db.transaction(['masterLocation'], 'readwrite');
                        const store = tx.objectStore('masterLocation');
                        await store.delete(validationCode);
                    } catch (error) {
                        console.error('Error deleting master location from IndexedDB:', error);
                    }
                }
                
                if (this.settings.enableLocalStorage) {
                    try {
                        let localStorageData = JSON.parse(localStorage.getItem(`masterLocationData_${this.userKey}`)) || [];
                        localStorageData = localStorageData.filter(item => item.validationCode !== validationCode);
                        localStorage.setItem(`masterLocationData_${this.userKey}`, JSON.stringify(localStorageData));
                    } catch (error) {
                        console.error('Error deleting master location from localStorage:', error);
                    }
                }
            }
            
            async saveMasterEan(data) {
                const dataArray = Array.isArray(data) ? data : [data];
                
                if (this.settings.enableIndexedDB && this.db) {
                    try {
                        const tx = this.db.transaction(['masterEan'], 'readwrite');
                        const store = tx.objectStore('masterEan');
                        
                        for (const item of dataArray) {
                            await store.put(item);
                        }
                    } catch (error) {
                        console.error('Error saving master EAN to IndexedDB:', error);
                    }
                }
                
                if (this.settings.enableLocalStorage) {
                    try {
                        if (Array.isArray(data)) {
                            localStorage.setItem(`masterEanData_${this.userKey}`, JSON.stringify(data));
                        } else {
                            let localStorageData = JSON.parse(localStorage.getItem(`masterEanData_${this.userKey}`)) || [];
                            const existingIndex = localStorageData.findIndex(item => item.ean === data.ean);
                            
                            if (existingIndex !== -1) {
                                localStorageData[existingIndex] = data;
                            } else {
                                localStorageData.push(data);
                            }
                            
                            localStorage.setItem(`masterEanData_${this.userKey}`, JSON.stringify(localStorageData));
                        }
                    } catch (error) {
                        console.error('Error saving master EAN to localStorage:', error);
                    }
                }
                
                return dataArray;
            }
            
            async getMasterEan() {
                if (this.settings.enableIndexedDB && this.db) {
                    try {
                        const tx = this.db.transaction(['masterEan'], 'readonly');
                        const store = tx.objectStore('masterEan');
                        
                        const data = await new Promise((resolve, reject) => {
                            const request = store.getAll();
                            request.onsuccess = () => resolve(request.result);
                            request.onerror = () => reject(request.error);
                        });
                        
                        return data;
                    } catch (error) {
                        console.warn('IndexedDB error for master EAN, fallback ke localStorage:', error);
                    }
                }
                
                if (this.settings.enableLocalStorage) {
                    try {
                        return JSON.parse(localStorage.getItem(`masterEanData_${this.userKey}`)) || [];
                    } catch (error) {
                        console.error('Error reading master EAN from localStorage:', error);
                        return [];
                    }
                }
                
                return [];
            }
            
            async deleteMasterEan(ean) {
                if (this.settings.enableIndexedDB && this.db) {
                    try {
                        const tx = this.db.transaction(['masterEan'], 'readwrite');
                        const store = tx.objectStore('masterEan');
                        await store.delete(ean);
                    } catch (error) {
                        console.error('Error deleting master EAN from IndexedDB:', error);
                    }
                }
                
                if (this.settings.enableLocalStorage) {
                    try {
                        let localStorageData = JSON.parse(localStorage.getItem(`masterEanData_${this.userKey}`)) || [];
                        localStorageData = localStorageData.filter(item => item.ean !== ean);
                        localStorage.setItem(`masterEanData_${this.userKey}`, JSON.stringify(localStorageData));
                    } catch (error) {
                        console.error('Error deleting master EAN from localStorage:', error);
                    }
                }
            }
            
            // ==============================
            // INVENTORY DATA METHODS
            // ==============================
            
            async saveInventory(data) {
                const dataArray = Array.isArray(data) ? data : [data];
                
                if (this.settings.enableIndexedDB && this.db) {
                    try {
                        const tx = this.db.transaction(['inventory'], 'readwrite');
                        const store = tx.objectStore('inventory');
                        
                        if (Array.isArray(data)) {
                            await store.clear();
                        }
                        
                        for (const item of dataArray) {
                            if (!item.id) {
                                item.id = Date.now() + Math.random().toString(36).substr(2, 9);
                            }
                            await store.add(item);
                        }
                    } catch (error) {
                        console.error('Error saving inventory to IndexedDB:', error);
                    }
                }
                
                if (this.settings.enableLocalStorage) {
                    try {
                        if (Array.isArray(data)) {
                            localStorage.setItem(`inventoryData_${this.userKey}`, JSON.stringify(data));
                        } else {
                            let localStorageData = JSON.parse(localStorage.getItem(`inventoryData_${this.userKey}`)) || [];
                            const existingIndex = localStorageData.findIndex(item => 
                                item.locationId === data.locationId && item.sku === data.sku
                            );
                            
                            if (existingIndex !== -1) {
                                localStorageData[existingIndex] = data;
                            } else {
                                localStorageData.push(data);
                            }
                            
                            localStorage.setItem(`inventoryData_${this.userKey}`, JSON.stringify(localStorageData));
                        }
                    } catch (error) {
                        console.error('Error saving inventory to localStorage:', error);
                    }
                }
                
                return dataArray;
            }
            
            async getInventory() {
                if (this.settings.enableIndexedDB && this.db) {
                    try {
                        const tx = this.db.transaction(['inventory'], 'readonly');
                        const store = tx.objectStore('inventory');
                        
                        const data = await new Promise((resolve, reject) => {
                            const request = store.getAll();
                            request.onsuccess = () => resolve(request.result);
                            request.onerror = () => reject(request.error);
                        });
                        
                        return data;
                    } catch (error) {
                        console.warn('IndexedDB error for inventory, fallback ke localStorage:', error);
                    }
                }
                
                if (this.settings.enableLocalStorage) {
                    try {
                        return JSON.parse(localStorage.getItem(`inventoryData_${this.userKey}`)) || [];
                    } catch (error) {
                        console.error('Error reading inventory from localStorage:', error);
                        return [];
                    }
                }
                
                return [];
            }
            
            async searchInventory(locationId, sku) {
                if (this.settings.enableIndexedDB && this.db) {
                    try {
                        const tx = this.db.transaction(['inventory'], 'readonly');
                        const store = tx.objectStore('inventory');
                        const index = store.index('location_sku');
                        
                        const data = await new Promise((resolve, reject) => {
                            const request = index.getAll([locationId, sku]);
                            request.onsuccess = () => resolve(request.result);
                            request.onerror = () => reject(request.error);
                        });
                        
                        return data;
                    } catch (error) {
                        console.warn('IndexedDB error for inventory search, fallback ke localStorage:', error);
                    }
                }
                
                if (this.settings.enableLocalStorage) {
                    try {
                        const allData = JSON.parse(localStorage.getItem(`inventoryData_${this.userKey}`)) || [];
                        return allData.filter(item => item.locationId === locationId && item.sku === sku);
                    } catch (error) {
                        console.error('Error searching inventory in localStorage:', error);
                        return [];
                    }
                }
                
                return [];
            }
            
            async deleteInventory(id) {
                if (this.settings.enableIndexedDB && this.db) {
                    try {
                        const tx = this.db.transaction(['inventory'], 'readwrite');
                        const store = tx.objectStore('inventory');
                        await store.delete(id);
                    } catch (error) {
                        console.error('Error deleting inventory from IndexedDB:', error);
                    }
                }
                
                if (this.settings.enableLocalStorage) {
                    try {
                        let localStorageData = JSON.parse(localStorage.getItem(`inventoryData_${this.userKey}`)) || [];
                        localStorageData = localStorageData.filter(item => item.id !== id);
                        localStorage.setItem(`inventoryData_${this.userKey}`, JSON.stringify(localStorageData));
                    } catch (error) {
                        console.error('Error deleting inventory from localStorage:', error);
                    }
                }
            }
            
            // ==============================
            // GITHUB SYNC METHODS
            // ==============================
            
            async exportAllData() {
                const cycleCount = await this.getCycleCount();
                const masterLocation = await this.getMasterLocation();
                const masterEan = await this.getMasterEan();
                const inventory = await this.getInventory();
                
                return {
                    cycleCount,
                    masterLocation,
                    masterEan,
                    inventory,
                    exportTimestamp: new Date().toISOString(),
                    version: '1.0'
                };
            }
            
            async importAllData(data) {
                if (data.cycleCount) {
                    for (const item of data.cycleCount) {
                        await this.saveCycleCount(item);
                    }
                }
                
                if (data.masterLocation) {
                    await this.saveMasterLocation(data.masterLocation);
                }
                
                if (data.masterEan) {
                    await this.saveMasterEan(data.masterEan);
                }
                
                if (data.inventory) {
                    await this.saveInventory(data.inventory);
                }
                
                return true;
            }
            
            // ==============================
            // STATISTICS METHODS
            // ==============================
            
            async getStorageStats() {
                const stats = {
                    cycleCount: { indexedDB: 0, localStorage: 0 },
                    masterLocation: { indexedDB: 0, localStorage: 0 },
                    masterEan: { indexedDB: 0, localStorage: 0 },
                    inventory: { indexedDB: 0, localStorage: 0 }
                };
                
                if (this.settings.enableIndexedDB && this.db) {
                    try {
                        const objectStores = [
                            { name: 'cycleCount', key: 'cycleCount' },
                            { name: 'masterLocation', key: 'masterLocation' },
                            { name: 'masterEan', key: 'masterEan' },
                            { name: 'inventory', key: 'inventory' }
                        ];
                        
                        for (const { name, key } of objectStores) {
                            const tx = this.db.transaction([name], 'readonly');
                            const store = tx.objectStore(name);
                            const count = await new Promise((resolve, reject) => {
                                const request = store.count();
                                request.onsuccess = () => resolve(request.result);
                                request.onerror = () => reject(request.error);
                            });
                            stats[key].indexedDB = count;
                        }
                    } catch (error) {
                        console.error('Error getting IndexedDB stats:', error);
                    }
                }
                
                if (this.settings.enableLocalStorage) {
                    try {
                        const cycleCountData = JSON.parse(localStorage.getItem(`cycleCountData_${this.userKey}`)) || [];
                        stats.cycleCount.localStorage = cycleCountData.length;
                        
                        const masterLocationData = JSON.parse(localStorage.getItem(`masterLocationData_${this.userKey}`)) || [];
                        stats.masterLocation.localStorage = masterLocationData.length;
                        
                        const masterEanData = JSON.parse(localStorage.getItem(`masterEanData_${this.userKey}`)) || [];
                        stats.masterEan.localStorage = masterEanData.length;
                        
                        const inventoryData = JSON.parse(localStorage.getItem(`inventoryData_${this.userKey}`)) || [];
                        stats.inventory.localStorage = inventoryData.length;
                    } catch (error) {
                        console.error('Error getting localStorage stats:', error);
                    }
                }
                
                return stats;
            }
            
            // ==============================
            // CLEANUP METHODS
            // ==============================
            
            async clearAllData() {
                if (this.settings.enableIndexedDB && this.db) {
                    try {
                        const objectStores = ['cycleCount', 'masterLocation', 'masterEan', 'inventory'];
                        
                        for (const storeName of objectStores) {
                            const tx = this.db.transaction([storeName], 'readwrite');
                            const store = tx.objectStore(storeName);
                            await store.clear();
                        }
                    } catch (error) {
                        console.error('Error clearing IndexedDB:', error);
                    }
                }
                
                if (this.settings.enableLocalStorage) {
                    try {
                        localStorage.removeItem(`cycleCountData_${this.userKey}`);
                        localStorage.removeItem(`masterLocationData_${this.userKey}`);
                        localStorage.removeItem(`masterEanData_${this.userKey}`);
                        localStorage.removeItem(`inventoryData_${this.userKey}`);
                    } catch (error) {
                        console.error('Error clearing localStorage:', error);
                    }
                }
            }
            
            async clearStorage(storageType) {
                if (storageType === 'indexeddb' && this.settings.enableIndexedDB && this.db) {
                    try {
                        const objectStores = ['cycleCount', 'masterLocation', 'masterEan', 'inventory'];
                        
                        for (const storeName of objectStores) {
                            const tx = this.db.transaction([storeName], 'readwrite');
                            const store = tx.objectStore(storeName);
                            await store.clear();
                        }
                    } catch (error) {
                        console.error('Error clearing IndexedDB:', error);
                    }
                } else if (storageType === 'localstorage' && this.settings.enableLocalStorage) {
                    try {
                        localStorage.removeItem(`cycleCountData_${this.userKey}`);
                        localStorage.removeItem(`masterLocationData_${this.userKey}`);
                        localStorage.removeItem(`masterEanData_${this.userKey}`);
                        localStorage.removeItem(`inventoryData_${this.userKey}`);
                    } catch (error) {
                        console.error('Error clearing localStorage:', error);
                    }
                }
            }
        }

        // ==============================
        // SYNC MANAGER - FIXED
        // ==============================
        
        class SyncManager {
            constructor(storageManager, githubSyncManager) {
                this.storageManager = storageManager;
                this.githubSyncManager = githubSyncManager;
                this.isSyncing = false;
            }

            async syncToGitHub(dataType, progressElement = null) {
                if (this.isSyncing) {
                    showToast('Sinkronisasi sedang berjalan, harap tunggu...', 'info');
                    return;
                }

                // Check GitHub connection
                if (!this.githubSyncManager.isConnected) {
                    const isConnected = await this.githubSyncManager.testConnection();
                    if (!isConnected) {
                        showToast('GitHub tidak terhubung. Silakan periksa konfigurasi GitHub.', 'error');
                        return;
                    }
                }

                this.isSyncing = true;
                const buttonId = `sync-${dataType.replace('_', '-')}`;
                this.setButtonState(buttonId, true);

                try {
                    let data;
                    switch(dataType) {
                        case 'cycle_count':
                            data = await this.storageManager.getCycleCount();
                            break;
                        case 'master_location':
                            data = await this.storageManager.getMasterLocation();
                            break;
                        case 'master_ean':
                            data = await this.storageManager.getMasterEan();
                            break;
                        case 'InventoryBalance':
                            data = await this.storageManager.getInventory();
                            break;
                        default:
                            throw new Error('Tipe data tidak dikenali');
                    }

                    if (progressElement) {
                        progressElement.style.display = 'block';
                        const progressBar = progressElement.querySelector('.progress-bar');
                        progressBar.style.width = '50%';
                    }

                    await this.githubSyncManager.syncDataWithGithub(dataType, data);
                    
                    if (progressElement) {
                        const progressBar = progressElement.querySelector('.progress-bar');
                        progressBar.style.width = '100%';
                    }

                    this.githubSyncManager.updateLastSyncTimestamps();
                    showToast(`Data ${dataType} berhasil disinkronisasi ke GitHub!`);
                    
                    // Tunggu sebentar sebelum menyembunyikan progress bar
                    setTimeout(() => {
                        if (progressElement) {
                            progressElement.style.display = 'none';
                            const progressBar = progressElement.querySelector('.progress-bar');
                            progressBar.style.width = '0%';
                        }
                    }, 1000);

                } catch (error) {
                    console.error(`Error syncing ${dataType}:`, error);
                    showToast(`Error sinkronisasi ${dataType}: ${error.message}`, 'error');
                    
                    if (progressElement) {
                        progressElement.style.display = 'none';
                        const progressBar = progressElement.querySelector('.progress-bar');
                        progressBar.style.width = '0%';
                    }
                } finally {
                    this.isSyncing = false;
                    this.setButtonState(buttonId, false);
                }
            }

            async syncFromGitHub(dataType, progressElement = null) {
                if (this.isSyncing) {
                    showToast('Sinkronisasi sedang berjalan, harap tunggu...', 'info');
                    return;
                }

                // Check GitHub connection
                if (!this.githubSyncManager.isConnected) {
                    const isConnected = await this.githubSyncManager.testConnection();
                    if (!isConnected) {
                        showToast('GitHub tidak terhubung. Silakan periksa konfigurasi GitHub.', 'error');
                        return;
                    }
                }

                this.isSyncing = true;
                const buttonId = `sync-from-github-${dataType.replace('_', '-')}`;
                this.setButtonState(buttonId, true);

                try {
                    if (progressElement) {
                        progressElement.style.display = 'block';
                        const progressBar = progressElement.querySelector('.progress-bar');
                        progressBar.style.width = '30%';
                    }

                    // Download data dari GitHub
                    const data = await this.githubSyncManager.downloadFromGitHub(
                        this.githubSyncManager.getFilenameForDataType(dataType)
                    ) || [];
                    
                    if (data.length > 0) {
                        if (progressElement) {
                            const progressBar = progressElement.querySelector('.progress-bar');
                            progressBar.style.width = '70%';
                        }
                        
                        // Save data berdasarkan tipe
                        switch(dataType) {
                            case 'cycle_count':
                                for (const item of data) {
                                    await this.storageManager.saveCycleCount(item);
                                }
                                break;
                            case 'master_location':
                                await this.storageManager.saveMasterLocation(data);
                                break;
                            case 'master_ean':
                                await this.storageManager.saveMasterEan(data);
                                break;
                            case 'InventoryBalance':
                                await this.storageManager.saveInventory(data);
                                break;
                        }
                    }

                    if (progressElement) {
                        const progressBar = progressElement.querySelector('.progress-bar');
                        progressBar.style.width = '100%';
                    }

                    if (data.length > 0) {
                        showToast(`Data ${dataType} berhasil disinkronisasi dari GitHub!`);
                    } else {
                        showToast(`Tidak ada data ${dataType} di GitHub`, 'info');
                    }
                    
                    // Refresh tampilan data
                    this.refreshDataDisplay(dataType);
                    
                    setTimeout(() => {
                        if (progressElement) {
                            progressElement.style.display = 'none';
                            const progressBar = progressElement.querySelector('.progress-bar');
                            progressBar.style.width = '0%';
                        }
                    }, 1000);
                } catch (error) {
                    console.error(`Error syncing ${dataType} from GitHub:`, error);
                    showToast(`Error memuat data ${dataType} dari GitHub: ${error.message}`, 'error');
                    
                    if (progressElement) {
                        progressElement.style.display = 'none';
                        const progressBar = progressElement.querySelector('.progress-bar');
                        progressBar.style.width = '0%';
                    }
                } finally {
                    this.isSyncing = false;
                    this.setButtonState(buttonId, false);
                }
            }

            setButtonState(buttonId, isLoading) {
                const button = document.getElementById(buttonId);
                if (!button) return;

                if (isLoading) {
                    button.disabled = true;
                    const originalHTML = button.innerHTML;
                    button.setAttribute('data-original-html', originalHTML);
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
                } else {
                    button.disabled = false;
                    const originalHTML = button.getAttribute('data-original-html');
                    if (originalHTML) {
                        button.innerHTML = originalHTML;
                    }
                }
            }

            refreshDataDisplay(dataType) {
                switch(dataType) {
                    case 'cycle_count':
                        renderDataCountTable();
                        break;
                    case 'master_location':
                        renderMasterLocationData();
                        break;
                    case 'master_ean':
                        renderMasterEanData();
                        break;
                    case 'InventoryBalance':
                        renderInventoryData();
                        break;
                }
            }

            async syncAllToGitHub() {
                if (this.isSyncing) {
                    showToast('Sinkronisasi sedang berjalan, harap tunggu...', 'info');
                    return;
                }

                // Check GitHub connection
                if (!this.githubSyncManager.isConnected) {
                    const isConnected = await this.githubSyncManager.testConnection();
                    if (!isConnected) {
                        showToast('GitHub tidak terhubung. Silakan periksa konfigurasi GitHub.', 'error');
                        return;
                    }
                }

                this.isSyncing = true;
                showToast('Memulai sinkronisasi semua data ke GitHub...', 'info');

                try {
                    await this.githubSyncManager.syncAllDataToGitHub();
                    
                    // Refresh semua tampilan data
                    await renderDataCountTable();
                    await renderMasterLocationData();
                    await renderMasterEanData();
                    await renderInventoryData();
                    
                    showToast('Semua data berhasil disinkronisasi!');
                } catch (error) {
                    console.error('Error during full sync:', error);
                    showToast(`Error sinkronisasi: ${error.message}`, 'error');
                } finally {
                    this.isSyncing = false;
                }
            }

            async syncAllFromGitHub() {
                if (this.isSyncing) {
                    showToast('Sinkronisasi sedang berjalan, harap tunggu...', 'info');
                    return;
                }

                // Check GitHub connection
                if (!this.githubSyncManager.isConnected) {
                    const isConnected = await this.githubSyncManager.testConnection();
                    if (!isConnected) {
                        showToast('GitHub tidak terhubung. Silakan periksa konfigurasi GitHub.', 'error');
                        return;
                    }
                }

                this.isSyncing = true;
                showToast('Memuat semua data dari GitHub...', 'info');

                try {
                    await this.githubSyncManager.syncFromGitHub();
                    
                    // Refresh semua tampilan data
                    await renderDataCountTable();
                    await renderMasterLocationData();
                    await renderMasterEanData();
                    await renderInventoryData();
                    
                    showToast('Semua data berhasil dimuat dari GitHub!');
                } catch (error) {
                    console.error('Error during full sync from GitHub:', error);
                    showToast(`Error memuat data: ${error.message}`, 'error');
                } finally {
                    this.isSyncing = false;
                }
            }
        }

        // ==============================
        // PAGINATION MANAGER
        // ==============================
        
        class PaginationManager {
            constructor(itemsPerPage = 15) {
                this.itemsPerPage = itemsPerPage;
                this.currentPages = {
                    'data-count': 1,
                    'master-location': 1,
                    'master-ean': 1,
                    'inventory': 1
                };
            }
            
            paginateData(data, dataType) {
                const currentPage = this.currentPages[dataType] || 1;
                const startIndex = (currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const paginatedData = data.slice(startIndex, endIndex);
                const totalPages = Math.ceil(data.length / this.itemsPerPage);
                
                return {
                    data: paginatedData,
                    currentPage: currentPage,
                    totalPages: totalPages,
                    totalItems: data.length,
                    startIndex: startIndex + 1,
                    endIndex: Math.min(endIndex, data.length)
                };
            }
            
            renderPagination(paginationInfo, dataType, containerId) {
                const paginationContainer = document.getElementById(containerId);
                if (!paginationContainer) return;
                
                const { currentPage, totalPages, totalItems, startIndex, endIndex } = paginationInfo;
                
                // Update pagination info
                const paginationInfoElement = document.getElementById(`${dataType}-pagination-info`);
                if (paginationInfoElement) {
                    paginationInfoElement.textContent = 
                        `Menampilkan ${startIndex}-${endIndex} dari ${totalItems} data`;
                }
                
                // Update pagination controls
                const paginationControls = document.getElementById(`${dataType}-pagination-controls`);
                if (!paginationControls) return;
                
                paginationControls.innerHTML = '';
                
                // Previous button
                const prevButton = document.createElement('button');
                prevButton.className = 'page-btn';
                prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevButton.disabled = currentPage === 1;
                prevButton.addEventListener('click', () => {
                    if (currentPage > 1) {
                        this.currentPages[dataType] = currentPage - 1;
                        this.triggerPaginationChange(dataType);
                    }
                });
                paginationControls.appendChild(prevButton);
                
                // Page buttons
                const maxVisiblePages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
                
                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageButton = document.createElement('button');
                    pageButton.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                    pageButton.textContent = i;
                    pageButton.addEventListener('click', () => {
                        this.currentPages[dataType] = i;
                        this.triggerPaginationChange(dataType);
                    });
                    paginationControls.appendChild(pageButton);
                }
                
                // Next button
                const nextButton = document.createElement('button');
                nextButton.className = 'page-btn';
                nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextButton.disabled = currentPage === totalPages;
                nextButton.addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        this.currentPages[dataType] = currentPage + 1;
                        this.triggerPaginationChange(dataType);
                    }
                });
                paginationControls.appendChild(nextButton);
            }
            
            triggerPaginationChange(dataType) {
                // Trigger re-render of the specific table
                switch(dataType) {
                    case 'data-count':
                        renderDataCountTable();
                        break;
                    case 'master-location':
                        renderMasterLocationData();
                        break;
                    case 'master-ean':
                        renderMasterEanData();
                        break;
                    case 'inventory':
                        renderInventoryData();
                        break;
                }
            }
            
            resetPagination(dataType) {
                this.currentPages[dataType] = 1;
            }
        }

        // ==============================
        // MAIN APPLICATION INTEGRATION
        // ==============================
        
        let currentUser = null;
        let userKey = null;
        let storageManager = null;
        let githubSyncManager = null;
        let syncManager = null;
        let paginationManager = null;
        let autoSyncInterval = null;
        
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'error' : type === 'info' ? 'info' : ''}`;
            toast.innerHTML = `
                <div><i class="fas ${type === 'error' ? 'fa-exclamation-circle' : type === 'info' ? 'fa-info-circle' : 'fa-check-circle'} me-2"></i> ${message}</div>
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 3000);
        }
        
        async function testGithubConnection(config = null) {
            if (config === null) {
                const githubTokenEl = document.getElementById('github-token');
                const githubOwnerEl = document.getElementById('github-owner');
                const githubRepoEl = document.getElementById('github-repo');
                
                if (!githubTokenEl || !githubOwnerEl || !githubRepoEl) {
                    console.error('Element konfigurasi GitHub tidak ditemukan');
                    return false;
                }
                
                config = {
                    token: githubTokenEl.value,
                    owner: githubOwnerEl.value,
                    repo: githubRepoEl.value
                };
            }
            
            const statusElement = document.getElementById('github-connection-status');
            const testResultElement = document.getElementById('github-connection-test-result');
            
            if (!config.token || !config.owner || !config.repo) {
                if (statusElement) {
                    statusElement.className = 'github-status disconnected';
                    statusElement.innerHTML = '<i class="fas fa-plug me-1"></i> GitHub: Tidak Terkonfigurasi';
                }
                if (testResultElement) {
                    testResultElement.innerHTML = '<div class="alert alert-warning mt-3">Konfigurasi GitHub belum lengkap</div>';
                }
                return false;
            }
            
            if (statusElement) {
                statusElement.className = 'github-status checking';
                statusElement.innerHTML = '<i class="fas fa-circle-notch fa-spin me-1"></i> GitHub: Mengecek...';
            }
            
            try {
                const url = `https://api.github.com/repos/${config.owner}/${config.repo}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    if (statusElement) {
                        statusElement.className = 'github-status connected';
                        statusElement.innerHTML = '<i class="fas fa-check-circle me-1"></i> GitHub: Terhubung';
                    }
                    if (testResultElement) {
                        testResultElement.innerHTML = '<div class="alert alert-success mt-3">Koneksi GitHub berhasil!</div>';
                    }
                    
                    // Update GitHubSyncManager connection status
                    if (githubSyncManager) {
                        githubSyncManager.isConnected = true;
                    }
                    
                    return true;
                } else {
                    if (statusElement) {
                        statusElement.className = 'github-status disconnected';
                        statusElement.innerHTML = '<i class="fas fa-times-circle me-1"></i> GitHub: Gagal';
                    }
                    if (testResultElement) {
                        testResultElement.innerHTML = `<div class="alert alert-danger mt-3">Gagal terhubung ke GitHub: ${response.status} ${response.statusText}</div>`;
                    }
                    
                    // Update GitHubSyncManager connection status
                    if (githubSyncManager) {
                        githubSyncManager.isConnected = false;
                    }
                    
                    return false;
                }
            } catch (error) {
                console.error('Error testing GitHub connection:', error);
                if (statusElement) {
                    statusElement.className = 'github-status disconnected';
                    statusElement.innerHTML = '<i class="fas fa-times-circle me-1"></i> GitHub: Error';
                }
                if (testResultElement) {
                    testResultElement.innerHTML = `<div class="alert alert-danger mt-3">Error: ${error.message}</div>`;
                }
                
                // Update GitHubSyncManager connection status
                if (githubSyncManager) {
                    githubSyncManager.isConnected = false;
                }
                
                return false;
            }
        }
        
        function resetGithubConnection() {
            const statusElement = document.getElementById('github-connection-status');
            if (statusElement) {
                statusElement.className = 'github-status disconnected';
                statusElement.innerHTML = '<i class="fas fa-plug me-1"></i> GitHub: Tidak Terhubung';
            }
            
            if (githubSyncManager) {
                githubSyncManager.resetConnection();
            }
        }
        
        function loadGithubConfig() {
            const githubToken = document.getElementById('github-token');
            const githubOwner = document.getElementById('github-owner');
            const githubRepo = document.getElementById('github-repo');
            const githubBranch = document.getElementById('github-branch');
            const syncInterval = document.getElementById('sync-interval');
            const autoSyncEnabled = document.getElementById('auto-sync-enabled');
            const saveGithubConfigBtn = document.getElementById('save-github-config');
            const testGithubConnectionBtn = document.getElementById('test-github-connection');
            const syncAllToGithubBtn = document.getElementById('sync-all-to-github');
            const syncAllFromGithubBtn = document.getElementById('sync-all-from-github');
            
            if (!githubToken || !githubOwner || !githubRepo || !githubBranch || !syncInterval || !autoSyncEnabled || !saveGithubConfigBtn) return;
            
            const config = JSON.parse(localStorage.getItem(`githubConfig_${userKey}`)) || {};
            githubToken.value = config.token || '';
            githubOwner.value = config.owner || '';
            githubRepo.value = config.repo || '';
            githubBranch.value = config.branch || 'main';
            syncInterval.value = config.syncInterval || 5;
            autoSyncEnabled.checked = config.autoSyncEnabled || false;
            
            // Update GitHubSyncManager config
            if (githubSyncManager) {
                githubSyncManager.config = config;
                testGithubConnection();
            }
            
            if (config.autoSyncEnabled) {
                startAutoSync(config.syncInterval || 5);
            }
            
            saveGithubConfigBtn.addEventListener('click', function() {
                const config = {
                    token: githubToken.value,
                    owner: githubOwner.value,
                    repo: githubRepo.value,
                    branch: githubBranch.value,
                    syncInterval: parseInt(syncInterval.value) || 5,
                    autoSyncEnabled: autoSyncEnabled.checked
                };
                
                localStorage.setItem(`githubConfig_${userKey}`, JSON.stringify(config));
                
                // Update GitHubSyncManager config
                if (githubSyncManager) {
                    githubSyncManager.config = config;
                }
                
                showToast('Konfigurasi GitHub berhasil disimpan!');
                
                testGithubConnection(config);
                
                if (autoSyncInterval) {
                    clearInterval(autoSyncInterval);
                    autoSyncInterval = null;
                }
                
                if (config.autoSyncEnabled) {
                    startAutoSync(config.syncInterval);
                }
            });
            
            testGithubConnectionBtn.addEventListener('click', function() {
                testGithubConnection();
            });
            
            syncAllToGithubBtn.addEventListener('click', function() {
                if (syncManager) {
                    syncManager.syncAllToGitHub();
                }
            });
            
            syncAllFromGithubBtn.addEventListener('click', function() {
                if (syncManager) {
                    syncManager.syncAllFromGitHub();
                }
            });
        }
        
        // ==============================
        // RENDER FUNCTIONS
        // ==============================
        
        async function renderDataCountTable() {
            const dataCountTable = document.getElementById('data-count-table') ? document.getElementById('data-count-table').querySelector('tbody') : null;
            const startDateFilter = document.getElementById('start-date');
            const endDateFilter = document.getElementById('end-date');
            
            if (!dataCountTable || !storageManager) return;
            
            const startDate = startDateFilter && startDateFilter.value ? new Date(startDateFilter.value) : new Date(0);
            const endDate = endDateFilter && endDateFilter.value ? new Date(endDateFilter.value) : new Date();
            endDate.setHours(23, 59, 59, 999);
            
            try {
                const cycleCountData = await storageManager.getCycleCount(startDate, endDate);
                
                // Apply pagination
                const paginationInfo = paginationManager.paginateData(cycleCountData, 'data-count');
                const paginatedData = paginationInfo.data;
                
                dataCountTable.innerHTML = '';
                
                if (paginatedData.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="8" class="text-center py-4 text-muted">Tidak ada data count</td>`;
                    dataCountTable.appendChild(row);
                    
                    // Hide pagination if no data
                    document.getElementById('data-count-pagination').style.display = 'none';
                    return;
                }
                
                // Show pagination
                document.getElementById('data-count-pagination').style.display = 'flex';
                
                paginatedData.forEach((item) => {
                    const row = document.createElement('tr');
                    const date = new Date(item.timestamp);
                    const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                    
                    row.innerHTML = `
                        <td>
                            <input type="checkbox" class="form-check-input data-checkbox" data-id="${item.id}">
                        </td>
                        <td>${formattedDate}</td>
                        <td>${item.location}</td>
                        <td>${item.ean}</td>
                        <td>${item.sku}</td>
                        <td>${item.countType}</td>
                        <td>${item.qty}</td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-data-btn" data-id="${item.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    dataCountTable.appendChild(row);
                });
                
                // Render pagination controls
                paginationManager.renderPagination(paginationInfo, 'data-count', 'data-count-pagination-controls');
                
                document.querySelectorAll('.data-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', updateSelectAllCheckbox);
                });
                
                document.querySelectorAll('.delete-data-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const id = this.getAttribute('data-id');
                        await deleteDataCountItem(id);
                    });
                });
            } catch (error) {
                console.error('Error rendering data count table:', error);
                showToast('Error memuat data count: ' + error.message, 'error');
            }
        }
        
        async function renderMasterLocationData() {
            const masterLocationTable = document.getElementById('master-location-table') ? document.getElementById('master-location-table').querySelector('tbody') : null;
            
            if (!masterLocationTable || !storageManager) return;
            
            try {
                const masterLocationData = await storageManager.getMasterLocation();
                
                // Apply pagination
                const paginationInfo = paginationManager.paginateData(masterLocationData, 'master-location');
                const paginatedData = paginationInfo.data;
                
                masterLocationTable.innerHTML = '';
                
                if (paginatedData.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="3" class="text-center py-4 text-muted">Tidak ada data master lokasi</td>`;
                    masterLocationTable.appendChild(row);
                    
                    // Hide pagination if no data
                    document.getElementById('master-location-pagination').style.display = 'none';
                    return;
                }
                
                // Show pagination
                document.getElementById('master-location-pagination').style.display = 'flex';
                
                paginatedData.forEach((item) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.validationCode || ''}</td>
                        <td>${item.location || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-master-location-btn" data-validationcode="${item.validationCode}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    masterLocationTable.appendChild(row);
                });
                
                // Render pagination controls
                paginationManager.renderPagination(paginationInfo, 'master-location', 'master-location-pagination-controls');
                
                document.querySelectorAll('.delete-master-location-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const validationCode = this.getAttribute('data-validationcode');
                        await deleteMasterLocationItem(validationCode);
                    });
                });
            } catch (error) {
                console.error('Error rendering master location data:', error);
                showToast('Error memuat data master lokasi: ' + error.message, 'error');
            }
        }
        
        async function renderMasterEanData() {
            const masterEanTable = document.getElementById('master-ean-table') ? document.getElementById('master-ean-table').querySelector('tbody') : null;
            
            if (!masterEanTable || !storageManager) return;
            
            try {
                const masterEanData = await storageManager.getMasterEan();
                
                // Apply pagination
                const paginationInfo = paginationManager.paginateData(masterEanData, 'master-ean');
                const paginatedData = paginationInfo.data;
                
                masterEanTable.innerHTML = '';
                
                if (paginatedData.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="3" class="text-center py-4 text-muted">Tidak ada data master EAN</td>`;
                    masterEanTable.appendChild(row);
                    
                    // Hide pagination if no data
                    document.getElementById('master-ean-pagination').style.display = 'none';
                    return;
                }
                
                // Show pagination
                document.getElementById('master-ean-pagination').style.display = 'flex';
                
                paginatedData.forEach((item) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.ean || ''}</td>
                        <td>${item.sku || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-master-ean-btn" data-ean="${item.ean}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    masterEanTable.appendChild(row);
                });
                
                // Render pagination controls
                paginationManager.renderPagination(paginationInfo, 'master-ean', 'master-ean-pagination-controls');
                
                document.querySelectorAll('.delete-master-ean-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const ean = this.getAttribute('data-ean');
                        await deleteMasterEanItem(ean);
                    });
                });
            } catch (error) {
                console.error('Error rendering master EAN data:', error);
                showToast('Error memuat data master EAN: ' + error.message, 'error');
            }
        }
        
        async function renderInventoryData() {
            const inventoryTable = document.getElementById('inventory-table') ? document.getElementById('inventory-table').querySelector('tbody') : null;
            
            if (!inventoryTable || !storageManager) return;
            
            try {
                const inventoryData = await storageManager.getInventory();
                
                // Apply pagination
                const paginationInfo = paginationManager.paginateData(inventoryData, 'inventory');
                const paginatedData = paginationInfo.data;
                
                inventoryTable.innerHTML = '';
                
                if (paginatedData.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="6" class="text-center py-4 text-muted">Tidak ada data inventory</td>`;
                    inventoryTable.appendChild(row);
                    
                    // Hide pagination if no data
                    document.getElementById('inventory-pagination').style.display = 'none';
                    return;
                }
                
                // Show pagination
                document.getElementById('inventory-pagination').style.display = 'flex';
                
                paginatedData.forEach((item) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.locationId || ''}</td>
                        <td>${item.sku || ''}</td>
                        <td>${item.skuDescrL || ''}</td>
                        <td>${item.traceId || ''}</td>
                        <td>${item.qtyOnHand || 0}</td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-inventory-btn" data-id="${item.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    inventoryTable.appendChild(row);
                });
                
                // Render pagination controls
                paginationManager.renderPagination(paginationInfo, 'inventory', 'inventory-pagination-controls');
                
                document.querySelectorAll('.delete-inventory-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const id = this.getAttribute('data-id');
                        await deleteInventoryItem(id);
                    });
                });
            } catch (error) {
                console.error('Error rendering inventory data:', error);
                showToast('Error memuat data inventory: ' + error.message, 'error');
                
                // Fallback: tampilkan pesan error di tabel
                const inventoryTable = document.getElementById('inventory-table') ? document.getElementById('inventory-table').querySelector('tbody') : null;
                if (inventoryTable) {
                    inventoryTable.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4 text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Error memuat data inventory: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }
        
        // ==============================
        // DELETE FUNCTIONS
        // ==============================
        
        async function deleteDataCountItem(id) {
            if (!confirm('Apakah Anda yakin ingin menghapus data ini?')) {
                return;
            }
            
            try {
                await storageManager.deleteCycleCount(id);
                await renderDataCountTable();
                showToast('Data berhasil dihapus');
            } catch (error) {
                console.error('Error deleting data count item:', error);
                showToast('Error menghapus data: ' + error.message, 'error');
            }
        }
        
        async function deleteMasterLocationItem(validationCode) {
            if (confirm('Apakah Anda yakin ingin menghapus data master lokasi ini?')) {
                try {
                    await storageManager.deleteMasterLocation(validationCode);
                    await renderMasterLocationData();
                    showToast('Data master lokasi berhasil dihapus!');
                } catch (error) {
                    console.error('Error deleting master location item:', error);
                    showToast('Error menghapus data master lokasi: ' + error.message, 'error');
                }
            }
        }
        
        async function deleteMasterEanItem(ean) {
            if (confirm('Apakah Anda yakin ingin menghapus data master EAN ini?')) {
                try {
                    await storageManager.deleteMasterEan(ean);
                    await renderMasterEanData();
                    showToast('Data master EAN berhasil dihapus!');
                } catch (error) {
                    console.error('Error deleting master EAN item:', error);
                    showToast('Error menghapus data master EAN: ' + error.message, 'error');
                }
            }
        }
        
        async function deleteInventoryItem(id) {
            if (confirm('Apakah Anda yakin ingin menghapus data inventory ini?')) {
                try {
                    await storageManager.deleteInventory(id);
                    await renderInventoryData();
                    showToast('Data inventory berhasil dihapus!');
                } catch (error) {
                    console.error('Error deleting inventory item:', error);
                    showToast('Error menghapus data inventory: ' + error.message, 'error');
                }
            }
        }
        
        function updateSelectAllCheckbox() {
            const allCheckboxes = document.querySelectorAll('.data-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.data-checkbox:checked');
            const selectAllCheckbox = document.getElementById('select-all');
            
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allCheckboxes.length > 0 && allCheckboxes.length === checkedCheckboxes.length;
            }
        }
        
        function startAutoSync(intervalMinutes) {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
            }

            // Initial sync
            autoSyncToGitHub();

            // Set up interval
            autoSyncInterval = setInterval(() => {
                console.log(`Auto-sync interval triggered (${intervalMinutes} minutes)`);
                autoSyncToGitHub();
            }, intervalMinutes * 60 * 1000);
        }
        
        async function autoSyncToGitHub() {
            const config = JSON.parse(localStorage.getItem(`githubConfig_${userKey}`)) || {};
            if (!config.autoSyncEnabled || !storageManager.settings.enableGitHubSync) {
                return;
            }

            if (!config.token || !config.owner || !config.repo) {
                return;
            }

            try {
                console.log('Starting auto-sync to GitHub...');
                await githubSyncManager.syncAllDataToGitHub();
                console.log('Auto-sync completed successfully');
            } catch (error) {
                console.error('Error during auto-sync:', error);
            }
        }
        
        async function renderStorageStatus() {
            if (!storageManager) return;
            
            try {
                const stats = await storageManager.getStorageStats();
                
                const indexedDBTotal = stats.cycleCount.indexedDB + stats.masterLocation.indexedDB + 
                                      stats.masterEan.indexedDB + stats.inventory.indexedDB;
                
                const localStorageTotal = stats.cycleCount.localStorage + stats.masterLocation.localStorage + 
                                         stats.masterEan.localStorage + stats.inventory.localStorage;
                
                const totalItems = indexedDBTotal + localStorageTotal;
                
                const indexedDBUsage = document.getElementById('indexeddb-usage');
                const localStorageUsage = document.getElementById('localstorage-usage');
                
                if (indexedDBUsage) {
                    const percentage = totalItems > 0 ? (indexedDBTotal / totalItems) * 100 : 0;
                    indexedDBUsage.style.width = `${percentage}%`;
                }
                
                if (localStorageUsage) {
                    const percentage = totalItems > 0 ? (localStorageTotal / totalItems) * 100 : 0;
                    localStorageUsage.style.width = `${percentage}%`;
                }
                
                const indexedDBStats = document.getElementById('indexeddb-stats');
                const localStorageStats = document.getElementById('localstorage-stats');
                
                if (indexedDBStats) {
                    indexedDBStats.textContent = `${indexedDBTotal} items`;
                }
                
                if (localStorageStats) {
                    localStorageStats.textContent = `${localStorageTotal} items`;
                }
                
                const enableIndexedDB = document.getElementById('enable-indexeddb');
                const enableLocalStorage = document.getElementById('enable-localstorage');
                const enableGitHubSync = document.getElementById('enable-github-sync');
                
                if (enableIndexedDB) {
                    enableIndexedDB.checked = storageManager.settings.enableIndexedDB;
                }
                
                if (enableLocalStorage) {
                    enableLocalStorage.checked = storageManager.settings.enableLocalStorage;
                }
                
                if (enableGitHubSync) {
                    enableGitHubSync.checked = storageManager.settings.enableGitHubSync;
                }
            } catch (error) {
                console.error('Error rendering storage status:', error);
            }
        }
        
        // ==============================
        // UPLOAD, DOWNLOAD, ADD FUNCTIONS
        // ==============================
        
        // Function to read Excel file
        function readExcelFile(file, onProgress) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        // Function to download data as Excel
        function downloadAsExcel(data, filename) {
            try {
                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Data');
                XLSX.writeFile(workbook, filename);
                return true;
            } catch (error) {
                console.error('Error downloading Excel file:', error);
                return false;
            }
        }
        
        // Master Location Functions
        function setupMasterLocationFunctions() {
            // Upload Master Location
            document.getElementById('upload-master-location-btn').addEventListener('click', function() {
                document.getElementById('master-location-file-input').click();
            });
            
            document.getElementById('master-location-file-input').addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const progressBar = document.getElementById('upload-master-location-progress');
                const progressText = document.getElementById('upload-master-location-text');
                progressBar.style.display = 'block';
                progressText.textContent = '0%';
                
                try {
                    const data = await readExcelFile(file);
                    
                    // Validate required columns
                    if (!data.length || !data[0]['Validation Code'] || !data[0]['Location']) {
                        throw new Error('Format file tidak valid. Pastikan file memiliki kolom "Validation Code" dan "Location".');
                    }
                    
                    // Transform data
                    const masterLocationData = data.map(row => ({
                        validationCode: row['Validation Code'],
                        location: row['Location']
                    }));
                    
                    // Update progress
                    if (progressBar) {
                        const progressFill = progressBar.querySelector('.progress-bar');
                        progressFill.style.width = '50%';
                        progressText.textContent = '50% - Menyimpan data...';
                    }
                    
                    // Save data to IndexedDB
                    await storageManager.saveMasterLocation(masterLocationData);
                    
                    if (progressBar) {
                        const progressFill = progressBar.querySelector('.progress-bar');
                        progressFill.style.width = '100%';
                        progressText.textContent = '100% - Selesai!';
                    }
                    
                    showToast('Data Master Lokasi berhasil diupload!');
                    await renderMasterLocationData();
                    
                    // Auto sync to GitHub jika enabled
                    const githubConfig = JSON.parse(localStorage.getItem(`githubConfig_${userKey}`)) || {};
                    if (githubConfig.autoSyncEnabled) {
                        setTimeout(() => {
                            syncManager.syncToGitHub('master_location', 
                                document.getElementById('sync-master-location-progress'));
                        }, 1000);
                    }
                } catch (error) {
                    console.error('Error uploading master location data:', error);
                    showToast('Error uploading data: ' + error.message, 'error');
                } finally {
                    setTimeout(() => {
                        progressBar.style.display = 'none';
                        const progressFill = progressBar.querySelector('.progress-bar');
                        progressFill.style.width = '0%';
                        progressText.textContent = '0%';
                    }, 2000);
                    e.target.value = '';
                }
            });
            
            // Download Master Location
            document.getElementById('download-master-location-btn').addEventListener('click', async function() {
                try {
                    const data = await storageManager.getMasterLocation();
                    if (data.length === 0) {
                        showToast('Tidak ada data untuk didownload', 'info');
                        return;
                    }
                    
                    // Transform data for Excel
                    const excelData = data.map(item => ({
                        'Validation Code': item.validationCode,
                        'Location': item.location
                    }));
                    
                    const success = downloadAsExcel(excelData, 'master_location.xlsx');
                    if (success) {
                        showToast('Data Master Lokasi berhasil didownload!');
                    } else {
                        showToast('Error downloading data', 'error');
                    }
                } catch (error) {
                    console.error('Error downloading master location data:', error);
                    showToast('Error downloading data: ' + error.message, 'error');
                }
            });
            
            // Clear Master Location
            document.getElementById('clear-master-location-btn').addEventListener('click', async function() {
                if (confirm('Apakah Anda yakin ingin menghapus semua data Master Lokasi?')) {
                    try {
                        const data = await storageManager.getMasterLocation();
                        for (const item of data) {
                            await storageManager.deleteMasterLocation(item.validationCode);
                        }
                        showToast('Semua data Master Lokasi berhasil dihapus!');
                        await renderMasterLocationData();
                    } catch (error) {
                        console.error('Error clearing master location data:', error);
                        showToast('Error menghapus data: ' + error.message, 'error');
                    }
                }
            });
            
            // Add Master Location
            document.getElementById('add-master-location-btn').addEventListener('click', function() {
                const validationCode = prompt('Masukkan Validation Code:');
                if (validationCode === null) return;
                
                const location = prompt('Masukkan Location:');
                if (location === null) return;
                
                if (!validationCode || !location) {
                    showToast('Validation Code dan Location harus diisi!', 'error');
                    return;
                }
                
                storageManager.saveMasterLocation({ validationCode, location })
                    .then(() => {
                        showToast('Data Master Lokasi berhasil ditambahkan!');
                        renderMasterLocationData();
                    })
                    .catch(error => {
                        console.error('Error adding master location data:', error);
                        showToast('Error menambah data: ' + error.message, 'error');
                    });
            });
            
            // Sync Master Location to GitHub
            document.getElementById('sync-master-location').addEventListener('click', async function() {
                await syncManager.syncToGitHub('master_location', 
                    document.getElementById('sync-master-location-progress'));
            });
            
            // Sync from GitHub for Master Location
            document.getElementById('sync-from-github-master-location').addEventListener('click', async function() {
                await syncManager.syncFromGitHub('master_location', 
                    document.getElementById('sync-master-location-progress'));
            });
        }
        
        // Master EAN Functions
        function setupMasterEanFunctions() {
            // Upload Master EAN
            document.getElementById('upload-master-ean-btn').addEventListener('click', function() {
                document.getElementById('master-ean-file-input').click();
            });
            
            document.getElementById('master-ean-file-input').addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const progressBar = document.getElementById('upload-master-ean-progress');
                const progressText = document.getElementById('upload-master-ean-text');
                progressBar.style.display = 'block';
                progressText.textContent = '0%';
                
                try {
                    const data = await readExcelFile(file);
                    
                    // Validate required columns
                    if (!data.length || !data[0]['EAN'] || !data[0]['SKU']) {
                        throw new Error('Format file tidak valid. Pastikan file memiliki kolom "EAN" dan "SKU".');
                    }
                    
                    // Transform data
                    const masterEanData = data.map(row => ({
                        ean: row['EAN'],
                        sku: row['SKU']
                    }));
                    
                    // Update progress
                    if (progressBar) {
                        const progressFill = progressBar.querySelector('.progress-bar');
                        progressFill.style.width = '50%';
                        progressText.textContent = '50% - Menyimpan data...';
                    }
                    
                    // Save data to IndexedDB
                    await storageManager.saveMasterEan(masterEanData);
                    
                    if (progressBar) {
                        const progressFill = progressBar.querySelector('.progress-bar');
                        progressFill.style.width = '100%';
                        progressText.textContent = '100% - Selesai!';
                    }
                    
                    showToast('Data Master EAN berhasil diupload!');
                    await renderMasterEanData();
                    
                    // Auto sync to GitHub jika enabled
                    const githubConfig = JSON.parse(localStorage.getItem(`githubConfig_${userKey}`)) || {};
                    if (githubConfig.autoSyncEnabled) {
                        setTimeout(() => {
                            syncManager.syncToGitHub('master_ean', 
                                document.getElementById('sync-master-ean-progress'));
                        }, 1000);
                    }
                } catch (error) {
                    console.error('Error uploading master EAN data:', error);
                    showToast('Error uploading data: ' + error.message, 'error');
                } finally {
                    setTimeout(() => {
                        progressBar.style.display = 'none';
                        const progressFill = progressBar.querySelector('.progress-bar');
                        progressFill.style.width = '0%';
                        progressText.textContent = '0%';
                    }, 2000);
                    e.target.value = '';
                }
            });
            
            // Download Master EAN
            document.getElementById('download-master-ean-btn').addEventListener('click', async function() {
                try {
                    const data = await storageManager.getMasterEan();
                    if (data.length === 0) {
                        showToast('Tidak ada data untuk didownload', 'info');
                        return;
                    }
                    
                    // Transform data for Excel
                    const excelData = data.map(item => ({
                        'EAN': item.ean,
                        'SKU': item.sku
                    }));
                    
                    const success = downloadAsExcel(excelData, 'master_ean.xlsx');
                    if (success) {
                        showToast('Data Master EAN berhasil didownload!');
                    } else {
                        showToast('Error downloading data', 'error');
                    }
                } catch (error) {
                    console.error('Error downloading master EAN data:', error);
                    showToast('Error downloading data: ' + error.message, 'error');
                }
            });
            
            // Clear Master EAN
            document.getElementById('clear-master-ean-btn').addEventListener('click', async function() {
                if (confirm('Apakah Anda yakin ingin menghapus semua data Master EAN?')) {
                    try {
                        const data = await storageManager.getMasterEan();
                        for (const item of data) {
                            await storageManager.deleteMasterEan(item.ean);
                        }
                        showToast('Semua data Master EAN berhasil dihapus!');
                        await renderMasterEanData();
                    } catch (error) {
                        console.error('Error clearing master EAN data:', error);
                        showToast('Error menghapus data: ' + error.message, 'error');
                    }
                }
            });
            
            // Add Master EAN
            document.getElementById('add-master-ean-btn').addEventListener('click', function() {
                const ean = prompt('Masukkan EAN:');
                if (ean === null) return;
                
                const sku = prompt('Masukkan SKU:');
                if (sku === null) return;
                
                if (!ean || !sku) {
                    showToast('EAN dan SKU harus diisi!', 'error');
                    return;
                }
                
                storageManager.saveMasterEan({ ean, sku })
                    .then(() => {
                        showToast('Data Master EAN berhasil ditambahkan!');
                        renderMasterEanData();
                    })
                    .catch(error => {
                        console.error('Error adding master EAN data:', error);
                        showToast('Error menambah data: ' + error.message, 'error');
                    });
            });
            
            // Sync Master EAN to GitHub
            document.getElementById('sync-master-ean').addEventListener('click', async function() {
                await syncManager.syncToGitHub('master_ean', 
                    document.getElementById('sync-master-ean-progress'));
            });
            
            // Sync from GitHub for Master EAN
            document.getElementById('sync-from-github-master-ean').addEventListener('click', async function() {
                await syncManager.syncFromGitHub('master_ean', 
                    document.getElementById('sync-master-ean-progress'));
            });
        }
        
        // Inventory Functions
        function setupInventoryFunctions() {
            // Upload Inventory
            document.getElementById('upload-inventory-btn').addEventListener('click', function() {
                document.getElementById('inventory-file-input').click();
            });
            
            document.getElementById('inventory-file-input').addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const progressBar = document.getElementById('upload-inventory-progress');
                const progressText = document.getElementById('upload-inventory-text');
                progressBar.style.display = 'block';
                progressText.textContent = '0%';
                
                try {
                    const data = await readExcelFile(file);
                    
                    // Validate required columns
                    if (!data.length || !data[0]['Location ID'] || !data[0]['SKU']) {
                        throw new Error('Format file tidak valid. Pastikan file memiliki kolom "Location ID" dan "SKU".');
                    }
                    
                    // Transform data
                    const inventoryData = data.map(row => ({
                        locationId: row['Location ID'],
                        sku: row['SKU'],
                        skuDescrL: row['SKU Descr(L)'] || '',
                        traceId: row['Trace ID'] || '',
                        qtyOnHand: row['QTY On Hand'] || 0
                    }));
                    
                    // Update progress
                    if (progressBar) {
                        const progressFill = progressBar.querySelector('.progress-bar');
                        progressFill.style.width = '50%';
                        progressText.textContent = '50% - Menyimpan data...';
                    }
                    
                    // Save data to IndexedDB
                    await storageManager.saveInventory(inventoryData);
                    
                    if (progressBar) {
                        const progressFill = progressBar.querySelector('.progress-bar');
                        progressFill.style.width = '100%';
                        progressText.textContent = '100% - Selesai!';
                    }
                    
                    showToast('Data Inventory berhasil diupload!');
                    await renderInventoryData();
                    
                    // Auto sync to GitHub jika enabled
                    const githubConfig = JSON.parse(localStorage.getItem(`githubConfig_${userKey}`)) || {};
                    if (githubConfig.autoSyncEnabled) {
                        setTimeout(() => {
                            syncManager.syncToGitHub('InventoryBalance', 
                                document.getElementById('sync-inventory-progress'));
                        }, 1000);
                    }
                } catch (error) {
                    console.error('Error uploading inventory data:', error);
                    showToast('Error uploading data: ' + error.message, 'error');
                } finally {
                    setTimeout(() => {
                        progressBar.style.display = 'none';
                        const progressFill = progressBar.querySelector('.progress-bar');
                        progressFill.style.width = '0%';
                        progressText.textContent = '0%';
                    }, 2000);
                    e.target.value = '';
                }
            });
            
            // Download Inventory
            document.getElementById('download-inventory-btn').addEventListener('click', async function() {
                try {
                    const data = await storageManager.getInventory();
                    if (data.length === 0) {
                        showToast('Tidak ada data untuk didownload', 'info');
                        return;
                    }
                    
                    // Transform data for Excel
                    const excelData = data.map(item => ({
                        'Location ID': item.locationId,
                        'SKU': item.sku,
                        'SKU Descr(L)': item.skuDescrL,
                        'Trace ID': item.traceId,
                        'QTY On Hand': item.qtyOnHand
                    }));
                    
                    const success = downloadAsExcel(excelData, 'inventory.xlsx');
                    if (success) {
                        showToast('Data Inventory berhasil didownload!');
                    } else {
                        showToast('Error downloading data', 'error');
                    }
                } catch (error) {
                    console.error('Error downloading inventory data:', error);
                    showToast('Error downloading data: ' + error.message, 'error');
                }
            });
            
            // Clear Inventory
            document.getElementById('clear-inventory-btn').addEventListener('click', async function() {
                if (confirm('Apakah Anda yakin ingin menghapus semua data Inventory?')) {
                    try {
                        const data = await storageManager.getInventory();
                        for (const item of data) {
                            await storageManager.deleteInventory(item.id);
                        }
                        showToast('Semua data Inventory berhasil dihapus!');
                        await renderInventoryData();
                    } catch (error) {
                        console.error('Error clearing inventory data:', error);
                        showToast('Error menghapus data: ' + error.message, 'error');
                    }
                }
            });
            
            // Add Inventory
            document.getElementById('add-inventory-btn').addEventListener('click', function() {
                const locationId = prompt('Masukkan Location ID:');
                if (locationId === null) return;
                
                const sku = prompt('Masukkan SKU:');
                if (sku === null) return;
                
                const skuDescrL = prompt('Masukkan SKU Description (opsional):');
                const traceId = prompt('Masukkan Trace ID (opsional):');
                const qtyOnHand = parseInt(prompt('Masukkan QTY On Hand:') || '0');
                
                if (!locationId || !sku) {
                    showToast('Location ID dan SKU harus diisi!', 'error');
                    return;
                }
                
                const inventoryItem = {
                    locationId,
                    sku,
                    skuDescrL: skuDescrL || '',
                    traceId: traceId || '',
                    qtyOnHand
                };
                
                storageManager.saveInventory(inventoryItem)
                    .then(() => {
                        showToast('Data Inventory berhasil ditambahkan!');
                        renderInventoryData();
                    })
                    .catch(error => {
                        console.error('Error adding inventory data:', error);
                        showToast('Error menambah data: ' + error.message, 'error');
                    });
            });
            
            // Sync Inventory to GitHub
            document.getElementById('sync-inventory').addEventListener('click', async function() {
                await syncManager.syncToGitHub('InventoryBalance', 
                    document.getElementById('sync-inventory-progress'));
            });
            
            // Sync from GitHub for Inventory
            document.getElementById('sync-from-github-inventory').addEventListener('click', async function() {
                await syncManager.syncFromGitHub('InventoryBalance', 
                    document.getElementById('sync-inventory-progress'));
            });
        }
        
        // Data Count Functions
        function setupDataCountFunctions() {
            // Export Data Count
            document.getElementById('export-btn').addEventListener('click', async function() {
                try {
                    const data = await storageManager.getCycleCount();
                    if (data.length === 0) {
                        showToast('Tidak ada data untuk diexport', 'info');
                        return;
                    }
                    
                    // Transform data for Excel
                    const excelData = data.map(item => ({
                        'Tanggal': new Date(item.timestamp).toLocaleString('id-ID'),
                        'Lokasi': item.location,
                        'EAN': item.ean,
                        'SKU': item.sku,
                        'Count Type': item.countType,
                        'Qty': item.qty,
                        'Remark': item.remark || '',
                        'Trace ID': item.traceId || ''
                    }));
                    
                    const success = downloadAsExcel(excelData, 'cycle_count_data.xlsx');
                    if (success) {
                        showToast('Data Cycle Count berhasil diexport!');
                    } else {
                        showToast('Error exporting data', 'error');
                    }
                } catch (error) {
                    console.error('Error exporting data count:', error);
                    showToast('Error exporting data: ' + error.message, 'error');
                }
            });
            
            // Delete Selected Data Count
            document.getElementById('delete-selected-btn').addEventListener('click', async function() {
                const selectedCheckboxes = document.querySelectorAll('.data-checkbox:checked');
                if (selectedCheckboxes.length === 0) {
                    showToast('Pilih data yang akan dihapus', 'info');
                    return;
                }
                
                if (!confirm(`Apakah Anda yakin ingin menghapus ${selectedCheckboxes.length} data?`)) {
                    return;
                }
                
                const idsToDelete = Array.from(selectedCheckboxes).map(checkbox => checkbox.getAttribute('data-id'));
                
                try {
                    await storageManager.deleteMultipleCycleCount(idsToDelete);
                    await renderDataCountTable();
                    showToast(`${idsToDelete.length} data berhasil dihapus`);
                } catch (error) {
                    console.error('Error deleting selected data count items:', error);
                    showToast('Error menghapus data: ' + error.message, 'error');
                }
            });
            
            // Select All Checkbox
            document.getElementById('select-all').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.data-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
            
            // Filter Data Count
            document.getElementById('filter-btn').addEventListener('click', function() {
                renderDataCountTable();
            });
            
            // Sync Cycle Count to GitHub
            document.getElementById('sync-cyclecount').addEventListener('click', async function() {
                await syncManager.syncToGitHub('cycle_count', 
                    document.getElementById('sync-cyclecount-progress'));
            });
            
            // Sync from GitHub for Cycle Count
            document.getElementById('sync-from-github-cyclecount').addEventListener('click', async function() {
                await syncManager.syncFromGitHub('cycle_count', 
                    document.getElementById('sync-cyclecount-progress'));
            });
            
            // Sync All Data
            document.getElementById('sync-all-data').addEventListener('click', async function() {
                await syncManager.syncAllToGitHub();
            });
        }
        
        // Storage Status Functions
        function setupStorageStatusFunctions() {
            // Refresh Storage Stats
            document.getElementById('refresh-storage-stats').addEventListener('click', function() {
                renderStorageStatus();
            });
            
            // Clear All Data
            document.getElementById('clear-all-data').addEventListener('click', async function() {
                if (confirm('Apakah Anda yakin ingin menghapus SEMUA data? Tindakan ini tidak dapat dibatalkan!')) {
                    try {
                        await storageManager.clearAllData();
                        showToast('Semua data berhasil dihapus!');
                        await renderDataCountTable();
                        await renderMasterLocationData();
                        await renderMasterEanData();
                        await renderInventoryData();
                        await renderStorageStatus();
                    } catch (error) {
                        console.error('Error clearing all data:', error);
                        showToast('Error menghapus data: ' + error.message, 'error');
                    }
                }
            });
            
            // Save Storage Settings
            document.getElementById('save-storage-settings').addEventListener('click', function() {
                const enableIndexedDB = document.getElementById('enable-indexeddb');
                const enableLocalStorage = document.getElementById('enable-localstorage');
                const enableGitHubSync = document.getElementById('enable-github-sync');
                
                if (storageManager) {
                    storageManager.settings.enableIndexedDB = enableIndexedDB.checked;
                    storageManager.settings.enableLocalStorage = enableLocalStorage.checked;
                    storageManager.settings.enableGitHubSync = enableGitHubSync.checked;
                    storageManager.saveSettings();
                    
                    showToast('Pengaturan penyimpanan berhasil disimpan!');
                }
            });
        }
        
        // ==============================
        // FORM CYCLE COUNT FUNCTIONS
        // ==============================
        
        function setupFormCycleCount() {
            const cycleCountForm = document.getElementById('cycleCountForm');
            const locationInput = document.getElementById('location');
            const eanInput = document.getElementById('ean');
            const skuInput = document.getElementById('sku');
            const descriptionInput = document.getElementById('description');
            const traceIdInput = document.getElementById('traceId');
            const countTypeSelect = document.getElementById('countType');
            const qtyInput = document.getElementById('qty');
            const remarkInput = document.getElementById('remark');
            const saveLocationBtn = document.getElementById('save-location-btn');
            const currentLocationDisplay = document.getElementById('current-location-display');
            const currentLocationName = document.getElementById('current-location-name');
            const currentLocationSkuCount = document.getElementById('current-location-sku-count');
            const notification = document.getElementById('notification');
            const countSaved = document.getElementById('count-saved');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const navInfo = document.getElementById('nav-info');
            const navigationContainer = document.getElementById('navigation-container');
            
            let currentLocation = null;
            let currentLocationInventory = [];
            let currentItemIndex = 0;
            
            // Save location button
            saveLocationBtn.addEventListener('click', async function() {
                const validationCode = locationInput.value.trim();
                if (!validationCode) {
                    showToast('Masukkan Validation Code terlebih dahulu', 'error');
                    return;
                }
                
                try {
                    const masterLocationData = await storageManager.getMasterLocation();
                    const location = masterLocationData.find(item => item.validationCode === validationCode);
                    
                    if (!location) {
                        showToast('Validation Code tidak ditemukan di Master Data Lokasi', 'error');
                        return;
                    }
                    
                    // Update location input with actual location code
                    locationInput.value = location.location;
                    currentLocation = location.location;
                    
                    // Show current location display
                    currentLocationName.textContent = location.location;
                    currentLocationDisplay.style.display = 'block';
                    
                    // Load inventory for this location
                    const inventoryData = await storageManager.getInventory();
                    currentLocationInventory = inventoryData.filter(item => item.locationId === location.location);
                    currentLocationSkuCount.textContent = currentLocationInventory.length;
                    
                    // Reset navigation
                    currentItemIndex = 0;
                    navigationContainer.style.display = currentLocationInventory.length > 0 ? 'block' : 'none';
                    updateNavigation();
                    
                    showToast(`Lokasi berhasil disimpan: ${location.location}`);
                } catch (error) {
                    console.error('Error saving location:', error);
                    showToast('Error menyimpan lokasi: ' + error.message, 'error');
                }
            });
            
            // EAN input with auto-complete
            eanInput.addEventListener('input', async function() {
                const ean = eanInput.value.trim();
                if (!ean) {
                    resetEanFields();
                    return;
                }
                
                try {
                    const masterEanData = await storageManager.getMasterEan();
                    const eanData = masterEanData.find(item => item.ean === ean);
                    
                    if (eanData) {
                        skuInput.value = eanData.sku;
                        await searchInventoryData(eanData.sku);
                    } else {
                        resetEanFields();
                    }
                } catch (error) {
                    console.error('Error searching EAN:', error);
                }
            });
            
            // Search inventory data
            async function searchInventoryData(sku) {
                if (!currentLocation) return;
                
                try {
                    const inventoryData = await storageManager.searchInventory(currentLocation, sku);
                    
                    if (inventoryData.length > 0) {
                        const item = inventoryData[0];
                        descriptionInput.value = item.skuDescrL || '';
                        traceIdInput.value = item.traceId || '';
                        
                        // Hide notification
                        notification.style.display = 'none';
                        countSaved.style.display = 'none';
                    } else {
                        descriptionInput.value = '';
                        traceIdInput.value = '';
                        
                        // Show notification
                        notification.style.display = 'block';
                        countSaved.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error searching inventory:', error);
                }
            }
            
            // Reset EAN fields
            function resetEanFields() {
                skuInput.value = '';
                descriptionInput.value = '';
                traceIdInput.value = '';
                notification.style.display = 'none';
                countSaved.style.display = 'none';
            }
            
            // Navigation functions
            function updateNavigation() {
                if (currentLocationInventory.length === 0) {
                    prevBtn.disabled = true;
                    nextBtn.disabled = true;
                    navInfo.textContent = 'Item 0 of 0';
                    return;
                }
                
                prevBtn.disabled = currentItemIndex === 0;
                nextBtn.disabled = currentItemIndex === currentLocationInventory.length - 1;
                navInfo.textContent = `Item ${currentItemIndex + 1} of ${currentLocationInventory.length}`;
                
                // Load current item data
                const currentItem = currentLocationInventory[currentItemIndex];
                if (currentItem) {
                    eanInput.value = '';
                    skuInput.value = currentItem.sku;
                    descriptionInput.value = currentItem.skuDescrL || '';
                    traceIdInput.value = currentItem.traceId || '';
                    
                    // Check if count already exists for this item
                    checkExistingCount(currentItem.sku);
                }
            }
            
            async function checkExistingCount(sku) {
                try {
                    const cycleCountData = await storageManager.getCycleCount();
                    const existingCount = cycleCountData.find(item => 
                        item.location === currentLocation && 
                        item.sku === sku && 
                        item.countType === countTypeSelect.value
                    );
                    
                    if (existingCount) {
                        qtyInput.value = existingCount.qty;
                        remarkInput.value = existingCount.remark || '';
                        qtyInput.disabled = true;
                        remarkInput.disabled = true;
                        countSaved.style.display = 'block';
                    } else {
                        qtyInput.value = '';
                        remarkInput.value = '';
                        qtyInput.disabled = false;
                        remarkInput.disabled = false;
                        countSaved.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error checking existing count:', error);
                }
            }
            
            prevBtn.addEventListener('click', function() {
                if (currentItemIndex > 0) {
                    currentItemIndex--;
                    updateNavigation();
                }
            });
            
            nextBtn.addEventListener('click', function() {
                if (currentItemIndex < currentLocationInventory.length - 1) {
                    currentItemIndex++;
                    updateNavigation();
                }
            });
            
            // Count type change
            countTypeSelect.addEventListener('change', function() {
                if (skuInput.value) {
                    checkExistingCount(skuInput.value);
                }
            });
            
            // Form submission
            cycleCountForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!currentLocation) {
                    showToast('Simpan lokasi terlebih dahulu', 'error');
                    return;
                }
                
                const ean = eanInput.value.trim();
                const sku = skuInput.value.trim();
                const countType = countTypeSelect.value;
                const qty = parseInt(qtyInput.value) || 0;
                const remark = remarkInput.value.trim();
                
                if (!sku) {
                    showToast('EAN/SKU harus diisi', 'error');
                    return;
                }
                
                if (qty < 0) {
                    showToast('Qty tidak boleh negatif', 'error');
                    return;
                }
                
                // Check if count already exists for this item and count type
                try {
                    const cycleCountData = await storageManager.getCycleCount();
                    const existingCount = cycleCountData.find(item => 
                        item.location === currentLocation && 
                        item.sku === sku && 
                        item.countType === countType
                    );
                    
                    if (existingCount) {
                        showToast('Count untuk tipe ini sudah ada dan hanya dapat dilihat', 'info');
                        return;
                    }
                } catch (error) {
                    console.error('Error checking existing count:', error);
                }
                
                // Prepare data
                const cycleCountData = {
                    timestamp: new Date().toISOString(),
                    location: currentLocation,
                    ean: ean,
                    sku: sku,
                    description: descriptionInput.value,
                    traceId: traceIdInput.value,
                    countType: countType,
                    qty: qty,
                    remark: remark
                };
                
                try {
                    // Save to storage
                    await storageManager.saveCycleCount(cycleCountData);
                    
                    showToast('Data count berhasil disimpan!');
                    
                    // Auto sync to GitHub jika enabled
                    const autoSyncToggle = document.getElementById('auto-sync-toggle');
                    if (autoSyncToggle && autoSyncToggle.checked) {
                        setTimeout(() => {
                            syncManager.syncToGitHub('cycle_count', 
                                document.getElementById('sync-cyclecount-progress'));
                        }, 500);
                    }
                    
                    // Reset form for next input
                    eanInput.value = '';
                    resetEanFields();
                    qtyInput.value = '';
                    remarkInput.value = '';
                    eanInput.focus();
                    
                    // Move to next item if in navigation mode
                    if (currentLocationInventory.length > 0 && currentItemIndex < currentLocationInventory.length - 1) {
                        currentItemIndex++;
                        updateNavigation();
                    }
                } catch (error) {
                    console.error('Error saving cycle count:', error);
                    showToast('Error menyimpan data: ' + error.message, 'error');
                }
            });
        }
        
        // ==============================
        // INITIALIZATION
        // ==============================
        
        function initializeApp() {
            // Setup sidebar toggle for mobile
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            const mobileNavBackdrop = document.getElementById('mobile-nav-backdrop');
            
            if (sidebarToggle && sidebar && mobileNavBackdrop) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('expanded');
                    mobileNavBackdrop.classList.toggle('expanded');
                });
                
                mobileNavBackdrop.addEventListener('click', function() {
                    sidebar.classList.remove('expanded');
                    mobileNavBackdrop.classList.remove('expanded');
                });
            }
            
            // Setup tab navigation
            const menuLinks = document.querySelectorAll('.sidebar-menu a[data-tab]');
            const tabContents = document.querySelectorAll('.tab-content');
            
            menuLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all links and contents
                    menuLinks.forEach(l => l.classList.remove('active'));
                    tabContents.forEach(c => {
                        c.classList.remove('active');
                        c.style.display = 'none';
                    });
                    
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    // Show corresponding tab content
                    const tabId = this.getAttribute('data-tab');
                    const tabContent = document.getElementById(`${tabId}-tab`);
                    if (tabContent) {
                        tabContent.classList.add('active');
                        tabContent.style.display = 'block';
                    }
                    
                    // Close sidebar on mobile after clicking a link
                    if (window.innerWidth < 992) {
                        sidebar.classList.remove('expanded');
                        mobileNavBackdrop.classList.remove('expanded');
                    }
                });
            });
            
            // Setup submenu toggle
            const submenuToggle = document.getElementById('master-data-menu');
            if (submenuToggle) {
                submenuToggle.addEventListener('click', function(e) {
                    if (e.target.tagName === 'A') {
                        e.preventDefault();
                        this.classList.toggle('expanded');
                        const submenu = this.querySelector('.sidebar-submenu');
                        if (submenu) {
                            submenu.classList.toggle('expanded');
                        }
                    }
                });
            }
            
            // Setup logout button
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    if (confirm('Apakah Anda yakin ingin logout?')) {
                        localStorage.removeItem('currentUser');
                        document.getElementById('login-container').style.display = 'flex';
                        document.getElementById('app-container').style.display = 'none';
                    }
                });
            }
            
            // Initialize managers
            userKey = currentUser ? currentUser.replace(/\s+/g, '_').toLowerCase() : 'default';
            storageManager = new HybridStorageManager(userKey);
            githubSyncManager = new GitHubSyncManager(storageManager, userKey);
            syncManager = new SyncManager(storageManager, githubSyncManager);
            paginationManager = new PaginationManager(15);
            
            // Wait for storage manager to initialize
            storageManager.initPromise.then(() => {
                // Setup GitHub configuration
                loadGithubConfig();
                
                // Setup all data management functions
                setupMasterLocationFunctions();
                setupMasterEanFunctions();
                setupInventoryFunctions();
                setupDataCountFunctions();
                setupStorageStatusFunctions();
                setupFormCycleCount();
                
                // Load last sync timestamps
                githubSyncManager.loadLastSyncTimestamps();
                
                // Render initial data
                renderDataCountTable();
                renderMasterLocationData();
                renderMasterEanData();
                renderInventoryData();
                renderStorageStatus();
                
                // Test GitHub connection
                testGithubConnection();
            }).catch(error => {
                console.error('Error initializing storage manager:', error);
                showToast('Error menginisialisasi penyimpanan: ' + error.message, 'error');
            });
        }
        
        // ==============================
        // LOGIN HANDLING
        // ==============================
        
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const remember = document.getElementById('remember').checked;
            
            // Simple authentication (in production, this should be server-side)
            if (username && password) {
                currentUser = username;
                
                // Save user info if remember is checked
                if (remember) {
                    localStorage.setItem('currentUser', username);
                }
                
                // Update UI
                document.getElementById('user-welcome').textContent = `Halo, ${username}`;
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                
                // Initialize app
                initializeApp();
            } else {
                alert('Username dan password harus diisi');
            }
        });
        
        // Check if user is already logged in
        window.addEventListener('DOMContentLoaded', function() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                document.getElementById('user-welcome').textContent = `Halo, ${savedUser}`;
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                initializeApp();
            }
        });
    </script>
</body>
</html>
